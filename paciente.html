<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel ClÃ­nico</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body{font-family:"Segoe UI",sans-serif;background:#f4f8ff;margin:0;color:#1a1a1a;overflow-x:hidden}
    header{background:#004aad;color:white;padding:12px 28px;display:flex;justify-content:space-between;align-items:center}
    header h1{font-size:1.4em;margin:0}
    header button{background:#fff2;border:none;border-radius:8px;padding:5px 12px;color:white;cursor:pointer}
    .info{display:flex;flex-wrap:wrap;gap:8px;background:white;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.1);
          padding:8px 15px;margin:15px 30px;font-size:0.9em}
    .info div{background:#f1f6ff;border-radius:6px;padding:4px 8px;flex:1 1 120px}
    .charts{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:0 30px 20px}
    .chart{background:white;border-radius:10px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
    canvas{width:100%!important;height:260px!important}
    footer{text-align:right;font-size:0.8em;color:#555;margin:5px 35px}
  </style>
</head>
<body>
<header>
  <button onclick="window.history.back()">â¬… Volver</button>
  <h1 id="nombre">Paciente</h1>
  <button id="pdfBtn">ðŸ“„ PDF</button>
</header>

<div id="panel">
  <div class="info" id="info"></div>
  <div class="charts">
    <div class="chart"><canvas id="radar"></canvas></div>
    <div class="chart"><canvas id="vitales"></canvas></div>
    <div class="chart"><canvas id="tolerancia"></canvas></div>
  </div>
</div>

<footer>Â© 2025 MedAI Assistant</footer>

<script>
const supabase = window.supabase.createClient(
  "https://aczjgeleupwlvghjhkav.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);
const id = new URLSearchParams(window.location.search).get("id");

async function cargar(){
  const {data:p}=await supabase.from("paciente").select("*").eq("patient_id",id).single();
  document.getElementById("nombre").textContent=p.nombre;
  document.getElementById("info").innerHTML=`
    <div><b>Edad:</b> ${p.edad}</div>
    <div><b>Sexo:</b> ${p.sexo}</div>
    <div><b>Peso:</b> ${p.peso_kg} kg</div>
    <div><b>Altura:</b> ${p.altura_cm} cm</div>
    <div><b>IMC:</b> ${p.imc}</div>
    <div><b>Motivo:</b> ${p.motivo_ingreso}</div>
    <div><b>Servicio:</b> ${p.servicio}</div>
    <div><b>Ingreso:</b> ${p.fecha_ingreso}</div>`;
  const {data:evol}=await supabase.from("evolucion_medica").select("*").eq("patient_id",id).order("fecha");
  if(!evol?.length)return;
  const first=evol[0], last=evol.at(-1);
  new Chart(radar,{type:"radar",data:{labels:["Dolor","Movilidad","Apetito","SueÃ±o","Tolerancia"],
    datasets:[{label:`Ingreso ${first.fecha}`,data:[first.dolor_nivel,first.movilidad,first.apetito,first.sueÃ±o_calidad,first.tolerancia_tratamiento],
      backgroundColor:"rgba(255,99,132,.2)",borderColor:"#ff6384"},
      {label:`Actual ${last.fecha}`,data:[last.dolor_nivel,last.movilidad,last.apetito,last.sueÃ±o_calidad,last.tolerancia_tratamiento],
      backgroundColor:"rgba(54,162,235,.2)",borderColor:"#36a2eb"}]},
    options:{plugins:{legend:{position:"bottom"}},scales:{r:{beginAtZero:true,max:10}}}});
  const {data:res}=await supabase.from("resultados_clinicos").select("*").eq("patient_id",id).order("fecha");
  new Chart(vitales,{type:"line",data:{labels:res.map(r=>r.fecha),
    datasets:[{label:"Temp",data:res.map(r=>r.temperatura),borderColor:"#ff9f40"},
              {label:"FC",data:res.map(r=>r.frecuencia_cardiaca),borderColor:"#4bc0c0"},
              {label:"SpOâ‚‚",data:res.map(r=>r.spo2),borderColor:"#9966ff"}]},
    options:{plugins:{legend:{position:"bottom"}},scales:{y:{max:100}}}});
  new Chart(tolerancia,{type:"bar",data:{labels:evol.map(e=>e.fecha),
    datasets:[{label:"Tolerancia",data:evol.map(e=>e.tolerancia_tratamiento),
    backgroundColor:"rgba(0,75,200,.3)",borderColor:"#004aad",borderWidth:1.5}]},
    options:{plugins:{legend:{display:false}},scales:{y:{max:10,beginAtZero:true}}}});
}
document.getElementById("pdfBtn").onclick=async()=>{
  const {jsPDF}=window.jspdf;const pdf=new jsPDF("l","pt","a4");
  const canvas=await html2canvas(document.getElementById("panel"),{scale:2});
  const img=canvas.toDataURL("image/png");const w=pdf.internal.pageSize.getWidth();
  const h=(canvas.height*w)/canvas.width;pdf.addImage(img,"PNG",0,0,w,h);pdf.save("informe.pdf");
};
cargar();
</script>
</body>
</html>
