<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>MedAI Evolution Assistant</title>

Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


Â  Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
Â Â 
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@3.0.0/dist/chartjs-chart-matrix.min.js"></script>


Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* Variables actualizadas para coincidir con el dashboard */
:root {
Â  /* Colores principales del dashboard */
Â  --blue-main: #1f3b73; /* Azul oscuro primario */
Â  --blue-accent: #3a6ff8; /* Azul claro de acento */
Â  --gray-bg: #f4f7fc; /* Fondo de la pÃ¡gina */
Â  --gray-dark: #2d2d2d; /* Texto principal */
Â  --gray-mid: #666; /* Texto secundario */
Â  --panel: #ffffff; /* Fondo de los paneles */
Â  --borde: #e9ecf3; /* Borde de los elementos */
Â  --verde: #27ae60; /* Verde normal/Ã©xito */
Â  --rojo: #e74c3c; /* Rojo crÃ­tico/error */
Â  --naranja: #f1c40f; /* Naranja lÃ­mite/advertencia */
Â  --radius: 10px; /* Radio de borde uniforme */
Â  --shadow: 0 3px 10px rgba(0,0,0,0.08); /* Sombra uniforme */
Â  --transition: all 0.3s ease;
}
body {
Â  font-family: 'Inter', sans-serif;
Â  background: var(--gray-bg);
Â  margin: 0;
Â  color: var(--gray-dark);
Â  overflow-x: hidden;
}

/* ==== CABECERA (Actualizada para el estilo del dashboard) ==== */
header {
Â  background: var(--panel); /* Fondo blanco */
Â  color: var(--blue-main);
Â  padding: 14px 40px;
Â  display: flex;
Â  justify-content: space-between;
Â  align-items: center;
Â  box-shadow: var(--shadow);
Â  position: sticky;
Â  top: 0;
Â  z-index: 10;
}
header h1 {
Â  font-size: 1.3rem;
Â  font-weight: 700;
Â  margin: 0;
Â  color: var(--blue-main);
Â  display: flex;
Â  align-items: center;
Â  gap: 10px;
}
header h1 i { /* AÃ±adido un icono para el tÃ­tulo */
Â  font-size: 1.5rem;
}


/* Estilo base para todos los botones, coincidiendo con el dashboard */
.btn {
Â  background-color: var(--blue-main);
Â  color: #fff;
Â  border: none;
Â  border-radius: var(--radius);
Â  padding: 8px 14px;
Â  font-size: 0.9rem;
Â  font-weight: 600;
Â  cursor: pointer;
Â  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
Â  transition: var(--transition);
Â  display: flex;
Â  align-items: center;
Â  gap: 6px;
}

.btn:hover {
Â  background-color: var(--blue-accent);
Â  transform: translateY(-2px);
Â  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15);
}

.btn:active {
Â  background-color: #1a305e; /* Un tono mÃ¡s oscuro */
Â  transform: translateY(0);
Â  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}

.botones-header {
Â  display: flex;
Â  gap: 12px;
Â  align-items: center;
Â  justify-content: flex-end;
}

/* Estilo especÃ­fico para el botÃ³n Volver */
.btn-volver {
Â  background-color: var(--gray-mid);
}

.btn-volver:hover {
Â  background-color: #4a4a4a;
}

/* ==== CONTENEDOR ==== */
main {
Â  max-width: 1300px; /* Aumentado para coincidir con el dashboard */
Â  margin: 30px auto;
Â  background: var(--panel);
Â  border-radius: var(--radius);
Â  padding: 30px 40px;
Â  box-shadow: var(--shadow);
}

/* ==== DATOS PACIENTE ==== */
#cabecera {
Â  display: flex;
Â  justify-content: space-between;
Â  margin-bottom: 20px;
Â  gap: 20px;
}
#paciente, #constantes {
Â  width: 50%; /* Usamos 50% para que queden alineados con el gap */
Â  background: var(--gray-bg); /* Un tono mÃ¡s claro que el fondo de la pÃ¡gina */
Â  border-radius: var(--radius);
Â  border: 1px solid var(--borde);
Â  padding: 15px 20px;
Â  font-size: 0.9rem;
Â  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}
#paciente p, #constantes p { margin: 5px 0; line-height: 1.4; }
#paciente b, #constantes b { color: var(--blue-main); font-weight: 600; }

/* ==== RESUMEN (Bloques de informaciÃ³n) ==== */
#bloqueIA, #bloqueRecomendacion {
Â  background: var(--gray-bg);
Â  border: 1px solid var(--borde);
Â  padding: 15px 20px;
Â  border-radius: var(--radius);
Â  margin-bottom: 20px;
}

#barraProgreso, #barraProgresoRec {
Â  height: 6px;
Â  width: 0;
Â  background: var(--blue-accent); /* Usar el azul de acento */
Â  border-radius: 4px;
Â  transition: width 0.4s;
}
#resumenIA, #resumenRec {
Â  margin-top: 10px;
Â  font-size: 0.95rem;
Â  min-height: 50px;
Â  line-height: 1.6;
}

/* ==== GRID PRINCIPAL ==== */
#panelCentral {
Â  display: grid;
Â  grid-template-columns: 2fr 1fr; /* MÃ¡s espacio para los grÃ¡ficos */
Â  gap: 25px;
}

/* ==== GRAFICOS (Panel Izquierdo) ==== */
#zonaGraficos {
Â  background: var(--panel); /* Fondo blanco para destacar */
Â  border: 1px solid var(--borde);
Â  border-radius: var(--radius);
Â  padding: 20px;
Â  text-align: center;
Â  display: flex;
Â  flex-direction: column;
Â  align-items: center;
Â  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

#graficoRadar, #graficoConstantes, #graficoHeat {
Â  width: 100%;
Â  max-width: 650px; /* Un poco mÃ¡s de espacio */
Â  height: 300px !important; /* Altura uniforme para todos los canvas */
Â  max-height: 300px;
Â  margin: 15px auto;
}

/* ==== TITULOS DENTRO DE BLOQUES ==== */
h3 {
Â  margin: 0 0 12px;
Â  color: var(--blue-main);
Â  font-size: 1.1rem;
Â  font-weight: 700;
}

/* ==== COLUMNA DERECHA (Paneles de informaciÃ³n) ==== */
.columna {
Â  background: var(--panel);
Â  border: 1px solid var(--borde);
Â  border-radius: var(--radius);
Â  padding: 15px;
Â  font-size: 0.9rem;
Â  margin-bottom: 20px;
Â  box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

/* ==== TABLAS (General) ==== */
table {
Â  width: 100%;
Â  border-collapse: collapse;
Â  font-size: 0.85rem;
}
th, td {
Â  border-bottom: 1px solid var(--borde);
Â  padding: 8px;
Â  text-align: left;
}
th {
Â  background: var(--blue-main);
Â  color: white;
Â  font-weight: 600;
Â  font-size: 0.9rem;
Â  border-bottom: 2px solid var(--blue-accent);
}
thead tr:first-child th:first-child { border-top-left-radius: 8px; }
thead tr:first-child th:last-child { border-top-right-radius: 8px; }
tbody tr:last-child td { border-bottom: none; }
#pruebasResultados tr:hover { background: #f9fafb; }


/* Estilos para el mapa de calor */
.heatmap-legend {
Â  font-size: 0.85rem;
Â  margin-top: 10px;
Â  text-align: center;
Â  display: flex;
Â  justify-content: center;
Â  gap: 15px;
}
.heatmap-legend span {
Â  padding: 4px 8px;
Â  border-radius: 4px;
Â  color: white;
Â  font-weight: 500;
}

/* Ajustes especÃ­ficos de las notas mÃ©dicas */
#tablaMedicos td:nth-child(3) {
Â  width: 60%; /* Dar mÃ¡s espacio al contenido de la nota */
}
#tablaMedicos tr {
Â  vertical-align: top;
}
#tablaMedicos tr:nth-child(even) {
Â  background: #f9fafb;
}

/* Responsividad bÃ¡sica */
@media (max-width: 1000px) {
Â  main { padding: 20px; }
Â  #panelCentral { grid-template-columns: 1fr; }
Â  #cabecera { flex-direction: column; gap: 15px; }
Â  #paciente, #constantes { width: 100%; }
Â  header { padding: 10px 20px; }
Â  .botones-header { gap: 8px; }
}

</style>
</head>

<body>
Â  <header>
Â  Â  <h1><i class="fa-solid fa-notes-medical"></i> MedAI Evolution Assistant</h1>

Â  Â  <div class="botones-header">
Â  Â  Â  <button class="btn btn-volver" onclick="window.location.href='index.html'">
Â  Â  Â  Â  <i class="fa-solid fa-arrow-left"></i> Volver al panel
Â  Â  Â  </button>
Â  Â  Â  <button class="btn" id="botonPDF" onclick="generarPDF()">
Â  Â  Â  Â  <i class="fa-solid fa-file-export"></i> Exportar informe
Â  Â  Â  </button>
Â  Â  </div>
Â  </header>

<main id="panel">
Â  Â  <div id="cabecera">
Â  Â  <div id="paciente">
Â  Â  Â  <h3><i class="fa-solid fa-user-injured"></i> Datos del Paciente</h3>
Â  Â  Â  <p><b>Nombre:</b> <span id="nombre"></span></p>
Â  Â  Â  <p><b>Edad:</b> <span id="edad"></span> â€” <b>Sexo:</b> <span id="sexo"></span></p>
Â  Â  Â  <p><b>DiagnÃ³stico:</b> <span id="diagnostico"></span></p>
Â  Â  Â  <p><b>Servicio:</b> <span id="servicio"></span></p>
Â  Â  </div>
Â  Â  <div id="constantes">
Â  Â  Â  <h3><i class="fa-solid fa-heart-pulse"></i> Ãšltimas Constantes Vitales</h3>
Â  Â  Â  <p><b>PresiÃ³n Arterial (PA):</b> <span id="pa"></span> mmHg</p>
Â  Â  Â  <p><b>Frecuencia Cardiaca (FC):</b> <span id="fc"></span> bpm</p>
Â  Â  Â  <p><b>SaturaciÃ³n Oâ‚‚ (SpOâ‚‚):</b> <span id="spo2"></span>%</p>
Â  Â  Â  <p><b>Temperatura (TÂª):</b> <span id="temp"></span> Â°C</p>
Â  Â  </div>
Â  </div>

Â  Â  <div id="bloqueIA">
Â  Â  <h3><i class="fa-solid fa-brain"></i> Resumen ClÃ­nico (IA)</h3>
Â  Â  <div id="barraProgreso"></div>
Â  Â  <div id="resumenIA">Cargando anÃ¡lisis...</div>
Â  </div>

Â  <div id="bloqueRecomendacion">
Â  Â  <h3><i class="fa-solid fa-lightbulb"></i> Recomendaciones ClÃ­nicas (IA)</h3>
Â  Â  <div id="barraProgresoRec"></div>
Â  Â  <div id="resumenRec">Cargando recomendaciones...</div>
Â  </div>

Â  Â  <div id="panelCentral">
Â  Â  Â  Â  <div id="zonaGraficos">
Â  Â  Â  <div class="navContainer">
Â  Â  Â  Â  <h3 id="tituloGraf"><i class="fa-solid fa-chart-line"></i> EvoluciÃ³n: Ingreso vs Alta</h3>
Â  Â  Â  </div>
Â  Â  Â  <canvas id="graficoRadar"></canvas>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div>
Â  Â  Â  <div class="columna">
Â  Â  Â  Â  <h3><i class="fa-solid fa-pills"></i> Tratamiento Actual</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>Medicamento</th><th>Dosis</th><th>VÃ­a</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="tablaMeds"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>

Â  Â  Â  <div class="columna" id="pruebasResultados">
Â  Â  Â  Â  <h3><i class="fa-solid fa-vial"></i> Pruebas y Resultados Iniciales</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  <th>ParÃ¡metro</th>
Â  Â  Â  Â  Â  Â  Â  <th>Resultado</th>
Â  Â  Â  Â  Â  Â  Â  <th>Valores de referencia</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="tablaLab">
Â  Â  Â  Â  Â  Â  <tr><td colspan="3" style="text-align:center;">Cargando resultados...</td></tr>
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>


Â  Â  Â  <div class="columna">
Â  Â  Â  Â  <h3><i class="fa-solid fa-user-tag"></i> EvoluciÃ³n y Equipo MÃ©dico</h3>
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead><tr><th>Nombre</th><th>Rol</th><th>Nota y Fecha</th></tr></thead>
Â  Â  Â  Â  Â  <tbody id="tablaMedicos"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</main>
<script type="module">
Â  // ImportaciÃ³n de Supabase (asume que 'supabaseClient.js' existe y exporta 'supabase')
Â  import { supabase } from './supabaseClient.js';

Â  const id = new URLSearchParams(window.location.search).get("id");

async function cargar() {
Â  try {
Â  Â  if (!id) {
Â  Â  Â  alert("âŒ No se ha indicado el paciente en la URL (?id=P001)");
Â  Â  Â  return;
Â  Â  }

Â  Â  console.log("ğŸ©º Cargando paciente", id);

Â  Â  // === PACIENTE ===
Â  Â  const { data: p, error: errorPaciente } = await supabase
Â  Â  Â  .from('pacientes')
Â  Â  Â  .select('*')
Â  Â  Â  .eq('PacienteID', id)
Â  Â  Â  .single();

Â  Â  if (errorPaciente || !p) {
Â  Â  Â  console.error("Error cargando paciente:", errorPaciente);
Â  Â  Â  alert("Paciente no encontrado o error en la carga.");
Â  Â  Â  return;
Â  Â  }

Â  Â  // === DATOS PRINCIPALES ===
Â  Â  document.getElementById('nombre').textContent = p.Nombre || 'â€”';
Â  Â  document.getElementById('edad').textContent = p.Edad || 'â€”';
Â  Â  document.getElementById('sexo').textContent = p.Sexo || 'â€”';
Â  Â  document.getElementById('diagnostico').textContent = p.DiagnosticoPrincipal || 'â€”';
Â  Â  document.getElementById('servicio').textContent = p.Servicio || 'â€”';

Â  Â  // === CONSULTAS A SUPABASE ===
Â  Â  const { data: evol } = await supabase
Â  Â  Â  .from('evolucion')
Â  Â  Â  .select('*')
Â  Â  Â  .eq('PacienteID', id)
Â  Â  Â  .order('Fecha');

Â  Â  const { data: meds } = await supabase
Â  Â  Â  .from('medicacion')
Â  Â  Â  .select('*')
Â  Â  Â  .eq('PacienteID', id);

Â  Â  const { data: signosRaw, error: errorSignos } = await supabase
Â  Â  Â  .from('signos_vitales')
Â  Â  Â  .select('*')
Â  Â  Â  .eq('PacienteID', id);

Â  Â  if (errorSignos) console.error("Error cargando signos vitales:", errorSignos);

Â  Â  // === ORDENAR LOCALMENTE ===
Â  Â  const signos = (signosRaw || [])
Â  Â  Â  .filter(s => s.Fecha && s.Hora)
Â  Â  Â  .sort((a, b) => {
Â  Â  Â  Â  const f1 = new Date(`${a.Fecha}T${a.Hora}`);
Â  Â  Â  Â  const f2 = new Date(`${b.Fecha}T${b.Hora}`);
Â  Â  Â  Â  return f1 - f2;
Â  Â  Â  });

Â  Â  // === SIGNOS VITALES ===
Â  Â  if (!signos.length) {
Â  Â  Â  console.warn("âš ï¸ No hay registros de signos vitales para este paciente");
Â  Â  Â  document.getElementById('pa').textContent = 'â€”';
Â  Â  Â  document.getElementById('fc').textContent = 'â€”';
Â  Â  Â  document.getElementById('spo2').textContent = 'â€”';
Â  Â  Â  document.getElementById('temp').textContent = 'â€”';
Â  Â  } else {
Â  Â  Â  const ult = signos
Â  Â  Â  Â  .filter(s => s.PresionSistolica && s.FrecuenciaCardiaca && s.SaturacionOxigeno && s.Temperatura)
Â  Â  Â  Â  .pop();

Â  Â  Â  if (ult) {
Â  Â  Â  Â  document.getElementById('pa').textContent = `${ult.PresionSistolica}/${ult.PresionDiastolica}`;
Â  Â  Â  Â  document.getElementById('fc').textContent = ult.FrecuenciaCardiaca;
Â  Â  Â  Â  document.getElementById('spo2').textContent = ult.SaturacionOxigeno;
Â  Â  Â  Â  document.getElementById('temp').textContent = ult.Temperatura;
Â  Â  Â  } else {
Â  Â  Â  Â  document.getElementById('pa').textContent = 'â€”';
Â  Â  Â  Â  document.getElementById('fc').textContent = 'â€”';
Â  Â  Â  Â  document.getElementById('spo2').textContent = 'â€”';
Â  Â  Â  Â  document.getElementById('temp').textContent = 'â€”';
Â  Â  Â  }

Â  Â  Â  renderConstantes(signos);
Â  Â  Â  renderHeatmap(signos);
Â  Â  }

Â  Â  // === EQUIPO MÃ‰DICO ===
Â  Â  const { data: notasCompletas, error: errorNotas } = await supabase
Â  Â  Â  .from("notas")
Â  Â  Â  .select("Fecha, Nota, personal_medico (Nombre, Rol)")
Â  Â  Â  .eq("PacienteID", id)
Â  Â  Â  .order("Fecha");

Â  Â  if (errorNotas) console.error("Error cargando notas:", errorNotas);
Â  Â  else renderNotas(notasCompletas);

Â  Â  // === PRUEBAS Y RESULTADOS ===
Â  Â  const { data: lab, error: errorLab } = await supabase
Â  Â  Â  .from("lab_iniciales")
Â  Â  Â  .select("Glucosa, pH, Cetonas, Creatinina, Hemoglobina, Leucocitos, Sodio, Potasio, Urea, Amilasa")
Â  Â  Â  .eq("PacienteID", id)
Â  Â  Â  .limit(1);

Â  Â  if (!errorLab && lab?.length) {
Â  Â  Â  const r = lab[0];
Â  Â  Â  document.getElementById("tablaLab").innerHTML = `
Â  Â  Â  Â  <tr><td>Glucosa</td><td>${r.Glucosa ?? "â€”"}</td><td>70â€“110 mg/dL</td></tr>
Â  Â  Â  Â  <tr><td>pH</td><td>${r.pH ?? "â€”"}</td><td>7.35â€“7.45</td></tr>
Â  Â  Â  Â  <tr><td>Cetonas</td><td>${r.Cetonas ?? "â€”"}</td><td>Negativas</td></tr>
Â  Â  Â  Â  <tr><td>Creatinina</td><td>${r.Creatinina ?? "â€”"}</td><td>0.6â€“1.3 mg/dL</td></tr>
Â  Â  Â  Â  <tr><td>Hemoglobina</td><td>${r.Hemoglobina ?? "â€”"}</td><td>12â€“17 g/dL</td></tr>
Â  Â  Â  Â  <tr><td>Leucocitos</td><td>${r.Leucocitos ?? "â€”"}</td><td>4â€“11 Ã—10â¹/L</td></tr>
Â  Â  Â  Â  <tr><td>Sodio</td><td>${r.Sodio ?? "â€”"}</td><td>135â€“145 mmol/L</td></tr>
Â  Â  Â  Â  <tr><td>Potasio</td><td>${r.Potasio ?? "â€”"}</td><td>3.5â€“5.1 mmol/L</td></tr>
Â  Â  Â  Â  <tr><td>Urea</td><td>${r.Urea ?? "â€”"}</td><td>10â€“50 mg/dL</td></tr>
Â  Â  Â  Â  <tr><td>Amilasa</td><td>${r.Amilasa ?? "â€”"}</td><td>30â€“110 U/L</td></tr>
Â  Â  Â  `;
Â  Â  }

Â  Â  // === RENDER RESTANTE ===
Â  Â  renderRadar(evol);
Â  Â  renderTabla('tablaMeds', meds, ['Medicamento', 'Dosis', 'Via']);

Â  Â  // Ejecuta ambas peticiones a la IA en paralelo
Â  Â  await Promise.all([
Â  Â  Â  generarResumenIA(p, evol, signos),
Â  Â  Â  generarRecomendacionIA(p, evol, signos)
Â  Â  ]);

Â  } catch (err) {
Â  Â  console.error("âš ï¸ Error en cargar():", err);
Â  Â  document.getElementById("resumenIA").textContent = "Error al cargar los datos del paciente.";
Â  }
}


Â  async function generarRecomendacionIA(p, evol, signos) {
Â  const barra = document.getElementById("barraProgresoRec");
Â  const resumenDiv = document.getElementById("resumenRec");
Â  resumenDiv.textContent = "Enviando datos a IA para recomendaciones...";
Â  barra.style.width = "0%";

Â  // Mismo payload que se envÃ­a a /evolucion
Â  const payload = {
Â  Â  paciente: p,
Â  Â  evolucion: evol,
Â  Â  signos_vitales: signos
Â  };

Â  try {
Â  Â  // Endpoint de recomendaciones sigue siendo /recomendacion
Â  Â  const res = await fetch("https://rubaseval.app.n8n.cloud/webhook/recomendacion", {
Â  Â  Â  method: "POST",
Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  body: JSON.stringify(payload)
Â  Â  });

Â  Â  const texto = await res.text();
Â  Â  console.log("âœ… Respuesta RecomendaciÃ³n IA:", texto);

Â  Â  if (texto.trim().length > 0) {
Â  Â  Â  barra.style.width = "100%";
Â  Â  Â Â 
Â  Â  Â  // Convertimos **texto** a <strong style="color:var(--azul);>texto</strong>
Â  Â  Â  const textoHtml = texto.replace(
Â  Â  Â  Â  /\*\*(.*?)\*\*/g,Â 
Â  Â  Â  Â  '<strong style="color:var(--blue-accent);">$1</strong>' /* Usar blue-accent */
Â  Â  Â  );
Â  Â  Â Â 
Â  Â  Â  resumenDiv.innerHTML = `<div style="white-space: pre-wrap;">${textoHtml}</div>`;
Â  Â  } else {
Â  Â  Â  resumenDiv.textContent = "âš ï¸ La IA no devolviÃ³ texto.";
Â  Â  }

Â  } catch (err) {
Â  Â  console.error("âŒ Error RecomendaciÃ³n IA:", err);
Â  Â  resumenDiv.textContent = "Error al conectar con el asistente IA.";
Â  }
}


/* === RADAR === */
function renderRadar(evol) {
Â  if (!evol?.length) return;
Â  const ingreso = evol[0];
Â  const alta = evol[evol.length - 1];

Â  const ctx = document.getElementById("graficoRadar");

Â  new Chart(ctx, {
Â  Â  type: "bar",
Â  Â  data: {
Â  Â  Â  labels: [
Â  Â  Â  Â  "PresiÃ³n SistÃ³lica (mmHg)",
Â  Â  Â  Â  "Frecuencia Cardiaca (bpm)",
Â  Â  Â  Â  "SaturaciÃ³n Oâ‚‚ (%)",
Â  Â  Â  Â  "Glucosa (mg/dl)"
Â  Â  Â  ],
Â  Â  Â  datasets: [
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  label: "Ingreso",
Â  Â  Â  Â  Â  data: [
Â  Â  Â  Â  Â  Â  ingreso.PresionSistolica,
Â  Â  Â  Â  Â  Â  ingreso.FrecuenciaCardiaca,
Â  Â  Â  Â  Â  Â  ingreso.SaturacionOxigeno,
Â  Â  Â  Â  Â  Â  ingreso.Glucosa
Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  backgroundColor: "rgba(31, 59, 115, 0.7)", /* blue-main */
Â  Â  Â  Â  Â  borderRadius: 6
Â  Â  Â  Â  },
Â  Â  Â  Â  {
Â  Â  Â  Â  Â  label: "Alta",
Â  Â  Â  Â  Â  data: [
Â  Â  Â  Â  Â  Â  alta.PresionSistolica,
Â  Â  Â  Â  Â  Â  alta.FrecuenciaCardiaca,
Â  Â  Â  Â  Â  Â  alta.SaturacionOxigeno,
Â  Â  Â  Â  Â  Â  alta.Glucosa
Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  backgroundColor: "rgba(39, 174, 96, 0.7)", /* verde Ã©xito */
Â  Â  Â  Â  Â  borderRadius: 6
Â  Â  Â  Â  }
Â  Â  Â  ]
Â  Â  },
Â  Â  options: {
Â  Â  Â  responsive: true,
Â  Â  Â  maintainAspectRatio: false, /* Puesto a false para controlar mejor la altura */
Â  Â  Â  scales: {
Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  ticks: { font: { size: 12 } },
Â  Â  Â  Â  Â  grid: { display: false }
Â  Â  Â  Â  },
Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  beginAtZero: false,
Â  Â  Â  Â  Â  ticks: { font: { size: 12 } },
Â  Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  Â  display: true,
Â  Â  Â  Â  Â  Â  text: "Valor",
Â  Â  Â  Â  Â  Â  font: { weight: "bold" }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  plugins: {
Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  position: "bottom",
Â  Â  Â  Â  Â  labels: { font: { size: 13, weight: "600" } }
Â  Â  Â  Â  },
Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  display: false
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  });
}


/* === TABLAS === */
function renderTabla(id, datos, columnas) {
Â  document.getElementById(id).innerHTML = datos?.length
Â  Â  ? datos.map(d => `<tr>${columnas.map(c => `<td>${d[c] ?? '-'}</td>`).join('')}</tr>`).join('')
Â  Â  : `<tr><td colspan="${columnas.length}">Sin registros</td></tr>`;
}

/* === RESUMEN IA === */
async function generarResumenIA(p, evol, signos) {
Â  const barra = document.getElementById("barraProgreso");
Â  const resumenDiv = document.getElementById("resumenIA");
Â  resumenDiv.textContent = "Enviando datos a IA...";
Â  barra.style.width = "0%";

Â  // Preparar payload con toda la info del paciente
Â  const payload = {
Â  Â  paciente: p,
Â  Â  evolucion: evol,
Â  Â  signos_vitales: signos
Â  };

Â  try {
Â  Â  const res = await fetch("https://rubaseval.app.n8n.cloud/webhook/evolucion", {
Â  Â  Â  method: "POST",
Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  body: JSON.stringify(payload)
Â  Â  });

Â  Â  const texto = await res.text();
Â  Â  console.log("âœ… Respuesta IA:", texto);

Â  Â  if (texto.trim().length > 0) {
Â  Â  Â  barra.style.width = "100%";
Â  Â  Â Â 
Â  Â  Â  // Convertimos **texto** a <strong style="color:var(--blue-accent);>texto</strong>
Â  Â  Â  const textoHtml = texto.replace(
Â  Â  Â  Â  /\*\*(.*?)\*\*/g,Â 
Â  Â  Â  Â  '<strong style="color:var(--blue-accent);">$1</strong>' /* Usar blue-accent */
Â  Â  Â  );

Â  Â  Â  resumenDiv.innerHTML = `<div style="white-space: pre-wrap;">${textoHtml}</div>`;
Â  Â  } else {
Â  Â  Â  resumenDiv.textContent = "âš ï¸ La IA no devolviÃ³ texto.";
Â  Â  }

Â  } catch (err) {
Â  Â  console.error("âŒ Error IA:", err);
Â  Â  resumenDiv.textContent = "Error al conectar con el asistente IA.";
Â  }
}

function activarValoracion() {
Â  // Eliminada o reubicada si no es necesaria en esta pÃ¡gina
}


/* === GRAFICO DE CONSTANTES VITALES === */
function renderConstantes(signos) {
Â  if (!signos?.length) return;
Â  const zona = document.getElementById("zonaGraficos");

Â  // Crear contenedor del grÃ¡fico
Â  const cont = document.createElement("div");
Â  cont.style.marginTop = "20px";
Â  cont.style.width = "100%"; /* Asegurar que ocupa todo el ancho */

Â  // TÃ­tulo con el nuevo estilo
Â  cont.innerHTML = `
Â  Â  <h3>
Â  Â  Â  <i class="fa-solid fa-chart-area"></i> Tendencia de Constantes Vitales
Â  Â  </h3>
Â  Â  <canvas id="graficoConstantes" style="width:100%;max-width:650px;height:300px;max-height:300px;"></canvas>
Â  `;

Â  zona.appendChild(cont);

Â  const ctx = document.getElementById("graficoConstantes");

Â  // Asegurarse de que las fechas sean Ãºnicas o agrupadas, pero para una lÃ­nea simple, mapeamos
Â  const fechas = signos.map(s => {
Â  Â  const date = new Date(s.Fecha);
Â  Â  return `${date.getDate()}/${date.getMonth() + 1} - ${s.Hora.substring(0, 5)}`;
Â  });
Â  const fc = signos.map(s => s.FrecuenciaCardiaca);
Â  const temp = signos.map(s => s.Temperatura);

Â  new Chart(ctx, {
Â  Â  type: "line",
Â  Â  data: {
Â  Â  Â  labels: fechas,
Â  Â  Â  datasets: [
Â  Â  Â  Â  { label: "FC (bpm)", data: fc, borderColor: "var(--blue-accent)", borderWidth: 2, fill: false, tension: 0.1 },
Â  Â  Â  Â  { label: "Temperatura (Â°C)", data: temp, borderColor: "#f39c12", borderWidth: 2, fill: false, tension: 0.1 }
Â  Â  Â  ]
Â  Â  },
Â  Â  options: {
Â  Â  Â  responsive: true,
Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  scales: { y: { beginAtZero: false } },
Â  Â  Â  plugins: { legend: { position: "bottom" } }
Â  Â  }
Â  });
}

function renderHeatmap(signos) {
Â  if (!signos?.length) return;

Â  const zona = document.getElementById("zonaGraficos");

Â  // Contenedor del grÃ¡fico
Â  const cont = document.createElement("div");
Â  cont.style.marginTop = "20px";
Â  cont.style.width = "100%";

Â  // TÃ­tulo y canvas con la leyenda mejorada
Â  cont.innerHTML = `
Â  Â  <h3><i class="fa-solid fa-table-cells"></i> Mapa de Calor de Signos Vitales</h3>
Â  Â  <canvas id="graficoHeat"></canvas>
Â  Â  <div class="heatmap-legend">
Â  Â  Â  <span style="background:var(--verde);">Normal</span>
Â  Â  Â  <span style="background:var(--naranja);">LÃ­mite</span>
Â  Â  Â  <span style="background:var(--rojo);">CrÃ­tico</span>
Â  Â  </div>
Â  `;
Â  zona.appendChild(cont);

Â  const ctx = document.getElementById("graficoHeat");

Â  // ParÃ¡metros y fechas
Â  const parametros = ["PresiÃ³n SistÃ³lica", "FC", "Temperatura", "SpOâ‚‚"];
Â  const fechas = signos.map(s => {
Â  Â  const date = new Date(s.Fecha);
Â  Â  return `${date.getDate()}/${date.getMonth() + 1}`;
Â  });

Â  // Rangos normales
Â  const normal = {
Â  "PresiÃ³n SistÃ³lica": { min: 110, max: 130 },
Â  "FC": { min: 65, max: 90 },
Â  "Temperatura": { min: 36.2, max: 37.2 },
Â  "SpOâ‚‚": { min: 96, max: 99 }
Â  };

Â  // Datos para el heatmap
Â  const valores = signos.flatMap((s, i) => [
Â  Â  { x: i, y: 0, v: s.PresionSistolica },
Â  Â  { x: i, y: 1, v: s.FrecuenciaCardiaca },
Â  Â  { x: i, y: 2, v: s.Temperatura },
Â  Â  { x: i, y: 3, v: s.SaturacionOxigeno }
Â  ]).filter(d => d.v !== null && d.v !== undefined); // Filtrar nulos/undefined

Â  // Render del grÃ¡fico
Â  new Chart(ctx, {
Â  Â  type: 'matrix',
Â  Â  data: {
Â  Â  Â  datasets: [{
Â  Â  Â  Â  label: 'Signos vitales',
Â  Â  Â  Â  data: valores,
Â  Â  Â  Â  backgroundColor: ctx => {
Â  Â  Â  Â  Â  const { v, y } = ctx.raw;
Â  Â  Â  Â  Â  const param = parametros[y];
Â  Â  Â  Â  Â  const { min, max } = normal[param];
Â  Â  Â  Â  Â  if (v < min || v > 200) return "rgba(231, 76, 60, 0.85)";Â  Â  // rojo crÃ­tico (usando var)
Â  Â  Â  Â  Â  if (v > max || v > 130) return "rgba(241, 196, 15, 0.85)";Â  Â // naranja lÃ­mite (usando var)
Â  Â  Â  Â  Â  return "rgba(39, 174, 96, 0.85)";Â  Â  Â  Â  Â  Â  Â  Â  Â // verde normal (usando var)
Â  Â  Â  Â  },
Â  Â  Â  Â  borderWidth: 1,
Â  Â  Â  Â  borderColor: "#fff",
Â  Â  Â  Â  width: ctx => {
Â  Â  Â  Â  Â  const chart = ctx.chart;
Â  Â  Â  Â  Â  const area = chart.chartArea || {};
Â  Â  Â  Â  Â  const xCount = fechas.length;
Â  Â  Â  Â  Â  return area.width ? area.width / xCount - 3 : chart.width / xCount - 3;
Â  Â  Â  Â  },
Â  Â  Â  Â  height: ctx => {
Â  Â  Â  Â  Â  const chart = ctx.chart;
Â  Â  Â  Â  Â  const area = chart.chartArea || {};
Â  Â  Â  Â  Â  const yCount = parametros.length;
Â  Â  Â  Â  Â  return area.height ? area.height / yCount - 3 : chart.height / yCount - 3;
Â  Â  Â  Â  }
Â  Â  Â  }]
Â  Â  },
Â  Â  options: {
Â  Â  Â  layout: { padding: { top: 10, bottom: 10 } },
Â  Â  Â  plugins: {
Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  Â  title: ctx => `${parametros[ctx[0].raw.y]} â€” ${signos[ctx[0].raw.x].Hora.substring(0, 5)} ${fechas[ctx[0].raw.x]}`,
Â  Â  Â  Â  Â  Â  label: ctx => `Valor: ${ctx.raw.v}`
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  },
Â  Â  Â  Â  legend: { display: false },
Â  Â  Â  Â  title: { display: false }
Â  Â  Â  },
Â  Â  Â  scales: {
Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  offset: true,
Â  Â  Â  Â  Â  ticks: {
Â  Â  Â  Â  Â  Â  callback: v => fechas[v] || "",
Â  Â  Â  Â  Â  Â  maxRotation: 60,
Â  Â  Â  Â  Â  Â  minRotation: 60,
Â  Â  Â  Â  Â  Â  font: { size: 9 }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  grid: { display: false }
Â  Â  Â  Â  },
Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  ticks: {
Â  Â  Â  Â  Â  Â  callback: v => parametros[v] || "",
Â  Â  Â  Â  Â  Â  font: { size: 10 }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  grid: { display: false }
Â  Â  Â  Â  }
Â  Â  Â  }


Â  Â  }
Â  });
}

function renderNotas(notas) {
Â  const tabla = document.getElementById("tablaMedicos");
Â  if (!notas?.length) {
Â  Â  tabla.innerHTML = `<tr><td colspan="3">Sin notas registradas</td></tr>`;
Â  Â  return;
Â  }

Â  tabla.innerHTML = notas.map(n => `
Â  Â  <tr>
Â  Â  Â  <td>${n.personal_medico?.Nombre || "â€”"}</td>
Â  Â  Â  <td>${n.personal_medico?.Rol || "â€”"}</td>
Â  Â  Â  <td>
Â  Â  Â  Â  <div style="font-size:0.75rem; color:var(--gray-mid); margin-bottom: 2px;">${new Date(n.Fecha).toLocaleDateString()}</div>
Â  Â  Â  Â  <div style="font-size:0.85rem; color:var(--gray-dark);">${n.Nota}</div>
Â  Â  Â  </td>
Â  Â  </tr>
Â  `).join('');
}

async function generarPDF() {
Â  const { jsPDF } = window.jspdf;
Â  const contenedor = document.getElementById("panel");

Â  // Ajustar el scale para una mejor calidad en el PDF
Â  const canvas = await html2canvas(contenedor, { scale: 3, useCORS: true });
Â  const imgData = canvas.toDataURL("image/jpeg", 0.9); // Usar JPEG para menor tamaÃ±o de archivo con buena calidad

Â  const pdf = new jsPDF("p", "mm", "a4");
Â  const pageWidth = pdf.internal.pageSize.getWidth();
Â  const pageHeight = pdf.internal.pageSize.getHeight();

Â  const imgWidth = pageWidth;
Â  const imgHeight = (canvas.height * imgWidth) / canvas.width;

Â  if (imgHeight <= pageHeight) {
Â  Â  pdf.addImage(imgData, "JPEG", 0, 0, imgWidth, imgHeight);
Â  } else {
Â  Â  let position = 0;
Â  Â  while (position < imgHeight) {
Â  Â  Â  pdf.addImage(imgData, "JPEG", 0, -position, imgWidth, imgHeight);
Â  Â  Â  position += pageHeight;
Â  Â  Â  if (position < imgHeight) pdf.addPage();
Â  Â  }
Â  }

Â  // ğŸ§  Recuperar el usuario del login
Â  const usuario = JSON.parse(localStorage.getItem("usuario")) || {};
Â  const medicoNombre = usuario.Nombre || usuario.nombre || "MÃ©dico desconocido";
Â  const medicoEmail = usuario.correo_login || usuario.email || "correo no disponible";

Â  const nombrePaciente = document.getElementById("nombre")?.innerText || "resumen_paciente";
Â  const fechaActual = new Date().toLocaleString();

Â  // Pie de pÃ¡gina con usuario y correo
Â  pdf.setFontSize(9);
Â  pdf.text(
Â  Â  `Generado por: ${medicoNombre} (${medicoEmail}) â€” ${fechaActual}`,
Â  Â  pageWidth / 2,
Â  Â  pageHeight - 10,
Â  Â  { align: "center" }
Â  );

Â  pdf.save(`${nombrePaciente}_informe.pdf`);
}

// Necesario porque el script es mÃ³dulo
window.generarPDF = generarPDF;


/* === BOTÃ“N MANUAL EXTRA (Estilizado como btn) === */
const botonManual = document.createElement("button");
botonManual.textContent = "Generar resumen IA manualmente";
botonManual.className = "btn";
botonManual.style.marginTop = "10px";
botonManual.style.backgroundColor = "#95a5a6"; // Un color diferente para distinguirlo
botonManual.style.marginLeft = "auto";
botonManual.style.display = "block";
botonManual.onclick = async () => {
Â  const { data: p } = await supabase.from('pacientes').select('*').eq('PacienteID', id).single();
Â  const { data: evol } = await supabase.from('evolucion').select('*').eq('PacienteID', id).order('Fecha');
Â  // === PRUEBAS Y RESULTADOS (lab_iniciales) ===
Â  const { data: lab, error: errorLab } = await supabase
Â  Â  .from("lab_iniciales")
Â  Â  .select("Glucosa, pH, Cetonas, Creatinina, Hemoglobina, Leucocitos, Sodio, Potasio, Urea, Amilasa")
Â  Â  .eq("PacienteID", id)
Â  Â  .limit(1);
Â Â 
Â  const signosRaw = await supabase.from('signos_vitales').select('*').eq('PacienteID', id);
Â  const signos = (signosRaw.data || [])
Â  Â  .filter(s => s.Fecha && s.Hora)
Â  Â  .sort((a, b) => {
Â  Â  Â  const f1 = new Date(`${a.Fecha}T${a.Hora}`);
Â  Â  Â  const f2 = new Date(`${b.Fecha}T${b.Hora}`);
Â  Â  Â  return f1 - f2;
Â  Â  });
Â Â 
Â  if (!errorLab && lab?.length) {
Â  Â  const resultados = lab[0];
Â  Â  const tbody = document.getElementById("tablaLab");

Â  Â  tbody.innerHTML = `
Â  Â  Â  <tr><td>Glucosa</td><td>${resultados.Glucosa ?? "â€”"}</td><td>70â€“110 mg/dL</td></tr>
Â  Â  Â  <tr><td>pH</td><td>${resultados.pH ?? "â€”"}</td><td>7.35â€“7.45</td></tr>
Â  Â  Â  <tr><td>Cetonas</td><td>${resultados.Cetonas ?? "â€”"}</td><td>Negativas</td></tr>
Â  Â  Â  <tr><td>Creatinina</td><td>${resultados.Creatinina ?? "â€”"}</td><td>0.6â€“1.3 mg/dL</td></tr>
Â  Â  Â  <tr><td>Hemoglobina</td><td>${resultados.Hemoglobina ?? "â€”"}</td><td>12â€“17 g/dL</td></tr>
Â  Â  Â  <tr><td>Leucocitos</td><td>${resultados.Leucocitos ?? "â€”"}</td><td>4â€“11 Ã—10â¹/L</td></tr>
Â  Â  Â  <tr><td>Sodio</td><td>${resultados.Sodio ?? "â€”"}</td><td>135â€“145 mmol/L</td></tr>
Â  Â  Â  <tr><td>Potasio</td><td>${resultados.Potasio ?? "â€”"}</td><td>3.5â€“5.1 mmol/L</td></tr>
Â  Â  Â  <tr><td>Urea</td><td>${resultados.Urea ?? "â€”"}</td><td>10â€“50 mg/dL</td></tr>
Â  Â  Â  <tr><td>Amilasa</td><td>${resultados.Amilasa ?? "â€”"}</td><td>30â€“110 U/L</td></tr>
Â  Â  `;
Â  }

Â  await generarResumenIA(p, evol, signos);
Â  await generarRecomendacionIA(p, evol, signos);
};
document.getElementById("bloqueIA").appendChild(botonManual);

// === REGISTRO DEL PLUGIN MATRIX ===
if (window['chartjs-chart-matrix']) {
Â  Chart.register(window['chartjs-chart-matrix']);
Â  console.log("Plugin Matrix 3.0.0 registrado correctamente");
} else {
Â  console.warn("chartjs-chart-matrix no encontrado. Revisa la ruta del script.");
}


cargar();
</script>
</body>
