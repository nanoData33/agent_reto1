<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ficha Cl√≠nica del Paciente</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f9ff;
      margin: 0;
      color: #1a1a1a;
      padding: 0;
    }

    header {
      background: #004aad;
      color: white;
      padding: 18px 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    header h1 {
      margin: 0;
      font-size: 1.6em;
    }

    header button {
      background: #ffffff22;
      border: 1px solid #fff;
      border-radius: 8px;
      padding: 8px 16px;
      color: white;
      cursor: pointer;
      transition: 0.3s;
    }

    header button:hover {
      background: #ffffff44;
    }

    main {
      padding: 25px 40px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 20px 25px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .section h2 {
      margin-top: 0;
      color: #004aad;
      border-bottom: 2px solid #004aad30;
      padding-bottom: 6px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .info-item {
      background: #f6f9ff;
      border-radius: 8px;
      padding: 8px 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border-bottom: 1px solid #ddd;
      padding: 6px 10px;
      text-align: left;
      font-size: 0.9em;
    }

    th {
      background: #f0f5ff;
      color: #004aad;
    }

    .highlight {
      background: #e8f0ff;
      border-left: 4px solid #004aad;
      padding: 10px;
      border-radius: 6px;
    }

    footer {
      text-align: right;
      font-size: 0.8em;
      color: #666;
      padding: 10px 40px;
    }
  </style>
</head>
<body>
  <header>
    <button onclick="window.close()">‚¨Ö Volver</button>
    <h1 id="nombre">Paciente</h1>
    <button id="pdfBtn">üìÑ Exportar PDF</button>
  </header>

  <main>
    <section class="section" id="identificacion">
      <h2>Datos personales</h2>
      <div class="info-grid" id="info"></div>
    </section>

    <section class="section" id="evolucion">
      <h2>Evoluci√≥n m√©dica</h2>
      <div id="notas"></div>
    </section>

    <section class="section" id="resultados">
      <h2>Resultados cl√≠nicos recientes</h2>
      <table id="tabla-resultados">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Temp (¬∞C)</th>
            <th>FC</th>
            <th>Presi√≥n</th>
            <th>SpO‚ÇÇ</th>
            <th>Leucos</th>
            <th>PCR</th>
            <th>Creat</th>
            <th>Glucosa</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="section" id="tratamientos">
      <h2>Tratamientos y procedimientos</h2>
      <div id="trat-list"></div>
    </section>

    <section class="section" id="alta">
      <h2>Resumen de alta</h2>
      <div id="alta-info"></div>
    </section>
  </main>

  <footer>¬© 2025 MedAI Evolution Assistant</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const SUPABASE_URL = "https://aczjgeleupwlvghjhkav.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjempnZWxldXB3bHZnaGpoa2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzgwODMsImV4cCI6MjA3NjU1NDA4M30.-hQdLNDMw-i4vCpt_OXnzYss5MtVrCu76FhMCPcZPhM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const id = new URLSearchParams(window.location.search).get("id");

    async function loadData() {
      const { data: paciente } = await supabase.from("paciente").select("*").eq("patient_id", id).single();
      document.getElementById("nombre").textContent = paciente.nombre;

      document.getElementById("info").innerHTML = `
        <div class="info-item"><strong>Edad:</strong> ${paciente.edad} a√±os</div>
        <div class="info-item"><strong>Sexo:</strong> ${paciente.sexo}</div>
        <div class="info-item"><strong>Peso:</strong> ${paciente.peso_kg || "-"} kg</div>
        <div class="info-item"><strong>Altura:</strong> ${paciente.altura_cm || "-"} cm</div>
        <div class="info-item"><strong>IMC:</strong> ${paciente.imc || "-"} </div>
        <div class="info-item"><strong>Servicio:</strong> ${paciente.servicio || "-"} </div>
        <div class="info-item"><strong>Motivo ingreso:</strong> ${paciente.motivo_ingreso || "-"} </div>
        <div class="info-item"><strong>Fecha ingreso:</strong> ${paciente.fecha_ingreso || "-"} </div>
        <div class="info-item"><strong>Comorbilidades:</strong> ${paciente.comorbilidades || "Ninguna"} </div>
        <div class="info-item"><strong>Alergias:</strong> ${paciente.alergias || "No registradas"} </div>
      `;

      const { data: evol } = await supabase.from("evolucion_medica").select("*").eq("patient_id", id).order("fecha", { ascending: false });
      document.getElementById("notas").innerHTML = evol.map(e => `
        <div class="highlight">
          <strong>${e.fecha}</strong> ‚Äî ${e.estado_general || "Sin estado"}<br>
          <em>${e.nota_medica}</em><br>
          <small>Dolor: ${e.dolor_nivel}/10 | Movilidad: ${e.movilidad}/10 | Sue√±o: ${e.sue√±o_calidad}/10</small>
        </div>
      `).join("");

      const { data: res } = await supabase.from("resultados_clinicos").select("*").eq("patient_id", id).order("fecha", { ascending: false }).limit(5);
      document.querySelector("#tabla-resultados tbody").innerHTML = res.map(r => `
        <tr>
          <td>${r.fecha}</td>
          <td>${r.temperatura || "-"}</td>
          <td>${r.frecuencia_cardiaca || "-"}</td>
          <td>${r.presion_arterial || "-"}</td>
          <td>${r.spo2 || "-"}</td>
          <td>${r.leucocitos || "-"}</td>
          <td>${r.pcr_mg_l || "-"}</td>
          <td>${r.creatinina_mg_dl || "-"}</td>
          <td>${r.glucosa_mg_dl || "-"}</td>
        </tr>
      `).join("");

      const { data: trat } = await supabase.from("tratamientos").select("*").eq("patient_id", id);
      document.getElementById("trat-list").innerHTML = trat.map(t => `
        <div class="highlight">
          <strong>${t.tratamiento}</strong> (${t.via_administracion || "-"})<br>
          ${t.procedimientos || ""}<br>
          <small>Cambio: ${t.cambio_tratamiento || "-"} | Efectos: ${t.efectos_secundarios || "-"}</small>
        </div>
      `).join("");

      const { data: alta } = await supabase.from("alta_resumen").select("*").eq("patient_id", id).single();
      document.getElementById("alta-info").innerHTML = alta ? `
        <p><strong>Fecha alta:</strong> ${alta.fecha_alta}</p>
        <p><strong>Diagn√≥stico principal:</strong> ${alta.diagnostico_principal}</p>
        <p><strong>Diagn√≥sticos secundarios:</strong> ${alta.diagnosticos_secundarios}</p>
        <p><strong>Evoluci√≥n:</strong> ${alta.evolucion_resumen}</p>
        <p><strong>Tratamiento de alta:</strong> ${alta.tratamiento_alta}</p>
        <p><strong>Seguimiento:</strong> ${alta.seguimiento_recomendado}</p>
        <p><strong>Riesgo de reca√≠da:</strong> ${(alta.riesgo_recaida_estimado * 100).toFixed(1)}%</p>
        <p><strong>Modelo generador:</strong> ${alta.modelo_generador}</p>
      ` : "<p>No hay resumen de alta disponible.</p>";
    }

    loadData();
  </script>
</body>
</html>
