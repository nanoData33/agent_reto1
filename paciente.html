<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedAI Evolution Assistant</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Librer√≠as necesarias -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@3.0.0/dist/chartjs-chart-matrix.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --azul: #004aad;
  --gris: #f6f8fb;
  --panel: #ffffff;
  --borde: #e5e7eb;
  --verde: #16a34a;
}
body {
  font-family: 'Poppins', sans-serif;
  background: var(--gris);
  margin: 0;
  color: #1f2d3d;
  overflow-x: hidden;
}

/* ==== CABECERA ==== */
header {
  background: var(--azul);
  color: white;
  padding: 12px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
header h1 { font-size: 1rem; font-weight: 600; }

/* ==== CONTENEDOR ==== */
main {
  max-width: 1150px;
  margin: 20px auto;
  background: var(--panel);
  border-radius: 12px;
  padding: 25px 35px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}

/* ==== DATOS PACIENTE ==== */
#cabecera {
  display: flex;
  justify-content: space-between;
  margin-bottom: 15px;
}
#paciente, #constantes {
  width: 48%;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid var(--borde);
  padding: 10px 15px;
  font-size: 0.85rem;
}
#paciente p, #constantes p { margin: 3px 0; }

/* ==== RESUMEN ==== */
#bloqueIA {
  background: #f9fafb;
  border: 1px solid var(--borde);
  padding: 10px 15px;
  border-radius: 8px;
  margin-bottom: 18px;
}
#barraProgreso {
  height: 6px;
  width: 0;
  background: var(--azul);
  border-radius: 4px;
  transition: width 0.4s;
}
#resumenIA {
  margin-top: 8px;
  font-size: 0.9rem;
  min-height: 45px;
}

/* ==== GRID PRINCIPAL ==== */
#panelCentral {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

/* ==== GRAFICOS ==== */
#zonaGraficos {
  background: #f9fafb;
  border: 1px solid var(--borde);
  border-radius: 8px;
  padding: 10px 15px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#graficoRadar {
  width: 100%;
  max-width: 600px;
  height: 260px !important;
  max-height: 260px;
  margin: 10px auto;
}

/* ==== COLUMNA DERECHA ==== */
.columna {
  background: #f9fafb;
  border: 1px solid var(--borde);
  border-radius: 8px;
  padding: 10px;
  font-size: 0.85rem;
  margin-bottom: 10px;
}
h3 {
  margin: 5px 0 8px;
  color: var(--azul);
  font-size: 0.9rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
}
th, td {
  border-bottom: 1px solid var(--borde);
  padding: 4px;
}
th {
  background: var(--azul);
  color: white;
  font-weight: 500;
}
  
.btn {
  background-color: var(--azul);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease-in-out;
}

.btn:hover {
  background-color: #0a64d1;
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
}

.btn:active {
  background-color: #003a87;
  transform: translateY(0);
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}

.botones-header {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: flex-end;
}

#pruebasResultados table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
}

#pruebasResultados th, #pruebasResultados td {
  padding: 6px 10px;
  border-bottom: 1px solid #ddd;
}

#pruebasResultados th {
  background: var(--azul);
  color: #fff;
  font-weight: 500;
}

#pruebasResultados tr:hover {
  background: #f9fafb;
}

</style>
</head>

<body>
  <header>
    <h1>MedAI Evolution Assistant</h1>
  
    <div class="botones-header">
      <button class="btn" onclick="window.location.href='index.html'">
        ‚Üê Volver al panel
      </button>
      <button class="btn" id="botonPDF" onclick="generarPDF()">
        <i class="fa-solid fa-file-export"></i> Exportar informe completo
      </button>
    </div>
  </header>

<main id="panel">
  <!-- CABECERA -->
  <div id="cabecera">
    <div id="paciente">
      <p><b>Nombre:</b> <span id="nombre"></span></p>
      <p><b>Edad:</b> <span id="edad"></span> ‚Äî <b>Sexo:</b> <span id="sexo"></span></p>
      <p><b>Diagn√≥stico:</b> <span id="diagnostico"></span></p>
      <p><b>Servicio:</b> <span id="servicio"></span></p>
    </div>
    <div id="constantes">
      <p><b>√öltimas constantes:</b></p>
      <p>PA: <span id="pa"></span> mmHg</p>
      <p>FC: <span id="fc"></span> bpm</p>
      <p>SpO‚ÇÇ: <span id="spo2"></span>% ‚Äî T¬™: <span id="temp"></span> ¬∞C</p>
    </div>
  </div>

  <!-- RESUMEN IA -->
  <div id="bloqueIA">
    <h3>Resumen cl√≠nico (IA)</h3>
    <div id="barraProgreso"></div>
    <div id="resumenIA">Cargando an√°lisis...</div>
  </div>

  <!-- DOS COLUMNAS -->
  <div id="panelCentral">
    <!-- IZQUIERDA -->
    <div id="zonaGraficos">
      <div class="navContainer">
        <h3 id="tituloGraf">Evoluci√≥n: Ingreso vs Alta</h3>
      </div>
      <canvas id="graficoRadar"></canvas>
    </div>

    <!-- DERECHA -->
    <div>
      <div class="columna">
        <h3>Tratamiento actual</h3>
        <table>
          <thead><tr><th>Medicamento</th><th>Dosis</th><th>V√≠a</th></tr></thead>
          <tbody id="tablaMeds"></tbody>
        </table>
      </div>

      <div class="columna" id="pruebasResultados">
        <h3>Pruebas y resultados iniciales</h3>
        <table>
          <thead>
            <tr>
              <th>Par√°metro</th>
              <th>Resultado</th>
              <th>Valores de referencia</th>
            </tr>
          </thead>
          <tbody id="tablaLab">
            <tr><td colspan="3" style="text-align:center;">Cargando resultados...</td></tr>
          </tbody>
        </table>
      </div>


      <div class="columna">
        <h3>Equipo m√©dico</h3>
        <table>
          <thead><tr><th>Nombre</th><th>Rol</th><th></th></tr></thead>
          <tbody id="tablaMedicos"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>
<script type="module">
  import { supabase } from './supabaseClient.js';

  const id = new URLSearchParams(window.location.search).get("id");

async function cargar() {
  try {
    if (!id) {
      alert("‚ùå No se ha indicado el paciente en la URL (?id=P001)");
      return;
    }

    console.log("ü©∫ Cargando paciente", id);

    // === PACIENTE ===
    const { data: p } = await supabase
      .from('pacientes')
      .select('*')
      .eq('PacienteID', id)
      .single();

    if (!p) {
      alert("Paciente no encontrado.");
      return;
    }

    // === DATOS PRINCIPALES ===
    document.getElementById('nombre').textContent = p.Nombre;
    document.getElementById('edad').textContent = p.Edad;
    document.getElementById('sexo').textContent = p.Sexo;
    document.getElementById('diagnostico').textContent = p.DiagnosticoPrincipal;
    document.getElementById('servicio').textContent = p.Servicio;

    // === CONSULTAS A SUPABASE ===
    const { data: evol } = await supabase
      .from('evolucion')
      .select('*')
      .eq('PacienteID', id)
      .order('Fecha');

    const { data: meds } = await supabase
      .from('medicacion')
      .select('*')
      .eq('PacienteID', id);

    const { data: signos } = await supabase
      .from('signos_vitales')
      .select('*')
      .eq('PacienteID', id)
      .order('Fecha', { ascending: true })
      .order('Hora', { ascending: true });

    // === VISUALIZACI√ìN ===
    renderRadar(evol);
    renderTabla('tablaMeds', meds, ['Medicamento', 'Dosis', 'Via']);
    await generarResumenIA(p, evol, signos);

    // === NUEVO BLOQUE: RESUMEN + RECOMENDACIONES AUTOM√ÅTICAS ===
    const panel = document.getElementById("bloqueIA");
    let recomendacionesDiv = document.getElementById("bloqueRecomendaciones");

    if (!recomendacionesDiv) {
      recomendacionesDiv = document.createElement("div");
      recomendacionesDiv.id = "bloqueRecomendaciones";
      recomendacionesDiv.style.marginTop = "20px";
      recomendacionesDiv.style.background = "#f9fafb";
      recomendacionesDiv.style.border = "1px solid #e5e7eb";
      recomendacionesDiv.style.borderRadius = "8px";
      recomendacionesDiv.style.padding = "10px 15px";
      recomendacionesDiv.innerHTML = `
        <h3>Recomendaciones (IA)</h3>
        <div id="recomendacionesIA">Generando recomendaciones...</div>
      `;
      panel.insertAdjacentElement("afterend", recomendacionesDiv);
    }

    const baseUrl = "https://rubaseval.app.n8n.cloud/webhook/chat-reto1";
    const payloadBase = {
      paciente_id: p.PacienteID,
      nombre: p.Nombre,
      edad: p.Edad,
      sexo: p.Sexo,
      diagnostico: p.DiagnosticoPrincipal,
      servicio: p.Servicio,
      evolucion: evol,
      signos
    };

    // 1Ô∏è‚É£ RESUMEN EVOLUCI√ìN
    try {
      const resResumen = await fetch(baseUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...payloadBase,
          prompt: `Hazme un resumen de la evoluci√≥n de ${p.Nombre}`
        })
      });
      const textoResumen = await resResumen.text();
      if (textoResumen.trim()) {
        document.getElementById("resumenIA").innerHTML = `<div style="white-space: pre-wrap;">${textoResumen}</div>`;
      }
    } catch (err) {
      console.error("‚ö†Ô∏è Error obteniendo resumen de evoluci√≥n:", err);
    }

    // 2Ô∏è‚É£ RECOMENDACIONES
    try {
      const resRec = await fetch(baseUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          ...payloadBase,
          prompt: `Hazme recomendaciones para ${p.Nombre}`
        })
      });
      const textoRec = await resRec.text();
      if (textoRec.trim()) {
        document.getElementById("recomendacionesIA").innerHTML = `<div style="white-space: pre-wrap;">${textoRec}</div>`;
      }
    } catch (err) {
      console.error("‚ö†Ô∏è Error obteniendo recomendaciones:", err);
    }

  } catch (err) {
    console.error("‚ö†Ô∏è Error en cargar():", err);
  }
}

cargar();
</script>
</body>
</html>
