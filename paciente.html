<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MedAI Evolution Assistant</title>

  <!-- Fuente -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- Librer√≠as necesarias -->
  <!-- Chart.js principal -->
  <!-- Chart.js principal -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <!-- Plugin Matrix (versi√≥n 3.0.0, con MIME correcto) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@3.0.0/dist/chartjs-chart-matrix.min.js"></script>


  <!-- Generaci√≥n de PDF (jsPDF + autoTable) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Conexi√≥n a Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
  --azul: #1f3b73;
  --azul-acento: #3a6ff8;
  --gris-fondo: #eef2f7;    /* fondo general del body */
  --gris-panel: #f9fafb;    /* fondo de todos los bloques */
  --gris-borde: #d8dee9;
  --verde: #27ae60;
  --rojo: #e74c3c;
  --sombra: 0 3px 10px rgba(0,0,0,0.08);
}

body {
  font-family: 'Poppins', sans-serif;
  background: var(--gris-fondo);
  margin: 0;
  color: #1f2d3d;
  overflow-x: hidden;
}

/* ==== CABECERA ==== */
header {
  background: #fff;
  color: var(--azul);
  padding: 16px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--sombra);
  position: sticky;
  top: 0;
  z-index: 10;
}

header h1 {
  font-size: 1.1rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

header h1::before {
  content: "ü©∫";
  font-size: 1.3rem;
}

/* ==== CONTENEDOR ==== */
main {
  max-width: 1150px;
  margin: 20px auto;
  background: #ffffff;
  border-radius: 12px;
  padding: 25px 35px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
  position: relative;
}

/* ==== DATOS PACIENTE ==== */
#cabecera {
  display: flex;
  justify-content: space-between;
  gap: 20px;
  background: var(--gris-panel);           /* mismo gris que los otros paneles */
  border: 1px solid var(--gris-borde);     /* mismo borde gris */
  border-radius: 12px;
  box-shadow: var(--sombra);               /* misma sombra */
  padding: 20px 25px;
  margin-bottom: 25px;
}

#paciente, #constantes {
  width: 48%;
  background: var(--gris-panel);
  border-radius: 8px;
  border: 1px solid var(--borde);
  padding: 10px 15px;
  font-size: 0.85rem;
}
#paciente p, #constantes p { margin: 3px 0; }

/* ==== RESUMEN ==== */
#bloqueIA,
#bloqueRecomendacion {
  background: var(--gris-panel);
  border: 1px solid var(--gris-borde);
  border-radius: 12px;
  box-shadow: var(--sombra);
  padding: 20px;
  margin-bottom: 20px;
}

/* Uniformar encabezados de esos bloques */
#bloqueIA h3,
#bloqueRecomendacion h3 {
  color: var(--azul);
  font-size: 0.95rem;
  font-weight: 600;
  border-bottom: 2px solid var(--azul);
  padding-bottom: 4px;
  margin-bottom: 10px;
}

#barraProgreso {
  height: 6px;
  width: 0;
  background: var(--azul);
  border-radius: 4px;
  transition: width 0.4s;
}

#barraProgresoRec {
  height: 6px;
  width: 0;
  background: var(--azul);
  border-radius: 4px;
  transition: width 0.4s;
}
#resumenRec {
  margin-top: 8px;
  font-size: 0.9rem;
  min-height: 45px;
}
#resumenIA {
  margin-top: 8px;
  font-size: 0.9rem;
  min-height: 45px;
}

/* ==== GRID PRINCIPAL ==== */
#panelCentral {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

/* ==== GRAFICOS ==== */
#zonaGraficos {
  background: var(--gris-panel);
  border: 1px solid var(--gris-borde);
  border-radius: 12px;
  box-shadow: var(--sombra);
  padding: 20px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* Uniformizar t√≠tulos de los gr√°ficos */
#zonaGraficos h3 {
  text-align: center;                 /* todos centrados */
  color: var(--azul);
  font-size: 0.95rem;
  font-weight: 600;
  border-bottom: 2px solid var(--azul);
  padding-bottom: 4px;
  margin-bottom: 10px;
  width: 100%;
}


#graficoRadar {
  width: 100%;
  max-width: 600px;
  height: 260px !important;
  max-height: 260px;
  margin: 10px auto;
}

/* ==== COLUMNA DERECHA ==== */
.columna {
  background: var(--gris-panel);
  border: 1px solid var(--gris-borde);
  border-radius: 12px;
  box-shadow: var(--sombra);
  padding: 20px;
  margin-bottom: 20px;
}
h3 {
  margin: 5px 0 8px;
  color: var(--azul);
  font-size: 0.9rem;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
}
th, td {
  border-bottom: 1px solid var(--gris-borde);
  padding: 4px;
}
th {
  background: var(--azul);
  color: white;
  font-weight: 500;
}

.btn {
  background-color: var(--azul);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 18px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease-in-out;
}

.btn:hover {
  background-color: #0a64d1;
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
}

.btn:active {
  background-color: #003a87;
  transform: translateY(0);
  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
}

.botones-header {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: flex-end;
}

#pruebasResultados table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.8rem;
}

#pruebasResultados th, #pruebasResultados td {
  padding: 6px 10px;
  border-bottom: 1px solid #ddd;
}

#pruebasResultados th {
  background: var(--azul);
  color: #fff;
  font-weight: 500;
}

#pruebasResultados tr:hover {
  background: #f9fafb;
}
  
#infoPaciente, #infoConstantes {
  flex: 1;
  background: white;
  border-radius: 10px;
  border: 1px solid #e3e8ef;
  padding: 15px 20px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.03);
}

#infoPaciente h3,
#infoConstantes h3 {
  font-size: 0.95rem;
  color: var(--azul);
  font-weight: 600;
  margin-bottom: 10px;
  border-bottom: 2px solid var(--azul);
  padding-bottom: 4px;
}

.grid-datos {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px 15px;
  font-size: 0.85rem;
}

.constantes-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 15px;
  font-size: 0.9rem;
}

.constantes-grid .label {
  font-weight: 600;
  color: var(--azul);
}

#infoConstantes span {
  font-weight: 500;
}

</style>
</head>

<body>
  <header>
    <h1>MedAI Evolution Assistant</h1>

    <div class="botones-header">
      <button class="btn" onclick="window.location.href='index.html'">
        ‚Üê Volver al panel
      </button>
      <button class="btn" id="botonPDF" onclick="generarPDF()">
        <i class="fa-solid fa-file-export"></i> Exportar informe completo en PDF
      </button>
    </div>
  </header>

<main id="panel">
  <!-- CABECERA DEL PACIENTE -->
  <div id="cabecera">
    <div id="infoPaciente">
      <h3>Datos del paciente</h3>
      <div class="grid-datos">
        <div><b>Nombre:</b> <span id="nombre"></span></div>
        <div><b>Edad:</b> <span id="edad"></span></div>
        <div><b>Sexo:</b> <span id="sexo"></span></div>
        <div><b>Diagn√≥stico:</b> <span id="diagnostico"></span></div>
        <div><b>Servicio:</b> <span id="servicio"></span></div>
      </div>
    </div>
  
    <div id="infoConstantes">
      <h3>√öltimas constantes</h3>
      <div class="constantes-grid">
        <div><span class="label">PA:</span> <span id="pa"></span> <small>mmHg</small></div>
        <div><span class="label">FC:</span> <span id="fc"></span> <small>bpm</small></div>
        <div><span class="label">SpO‚ÇÇ:</span> <span id="spo2"></span> <small>%</small></div>
        <div><span class="label">T¬™:</span> <span id="temp"></span> <small>¬∞C</small></div>
      </div>
    </div>
  </div>

  <!-- RESUMEN IA -->
  <div id="bloqueIA">
    <h3>Resumen cl√≠nico (IA)</h3>
    <div id="barraProgreso"></div>
    <div id="resumenIA">Cargando an√°lisis...</div>
  </div>

  <div id="bloqueRecomendacion">
    <h3>Recomendaciones cl√≠nicas (IA)</h3>
    <div id="barraProgresoRec"></div>
    <div id="resumenRec">Cargando recomendaciones...</div>
  </div>

  <!-- DOS COLUMNAS -->
  <div id="panelCentral">
    <!-- IZQUIERDA -->
    <div id="zonaGraficos">
      <div class="navContainer">
        <h3 id="tituloGraf">Evoluci√≥n: Ingreso vs Alta</h3>
      </div>
      <canvas id="graficoRadar"></canvas>
    </div>

    <!-- DERECHA -->
    <div>
      <div class="columna">
        <h3>Tratamiento actual</h3>
        <table>
          <thead><tr><th>Medicamento</th><th>Dosis</th><th>V√≠a</th></tr></thead>
          <tbody id="tablaMeds"></tbody>
        </table>
      </div>

      <div class="columna" id="pruebasResultados">
        <h3>Pruebas y resultados iniciales</h3>
        <table>
          <thead>
            <tr>
              <th>Par√°metro</th>
              <th>Resultado</th>
              <th>Valores de referencia</th>
            </tr>
          </thead>
          <tbody id="tablaLab">
            <tr><td colspan="3" style="text-align:center;">Cargando resultados...</td></tr>
          </tbody>
        </table>
      </div>


      <div class="columna">
        <h3>Equipo m√©dico</h3>
        <table>
          <thead><tr><th>Nombre</th><th>Rol</th><th></th></tr></thead>
          <tbody id="tablaMedicos"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>
<script type="module">
  import { supabase } from './supabaseClient.js';

  const id = new URLSearchParams(window.location.search).get("id");

async function cargar() {
  try {
    if (!id) {
      alert("‚ùå No se ha indicado el paciente en la URL (?id=P001)");
      return;
    }

    console.log("ü©∫ Cargando paciente", id);

    // === PACIENTE ===
    const { data: p, error: errorPaciente } = await supabase
      .from('pacientes')
      .select('*')
      .eq('PacienteID', id)
      .single();

    if (errorPaciente || !p) {
      console.error("Error cargando paciente:", errorPaciente);
      alert("Paciente no encontrado o error en la carga.");
      return;
    }

    // === DATOS PRINCIPALES ===
    document.getElementById('nombre').textContent = p.Nombre || '‚Äî';
    document.getElementById('edad').textContent = p.Edad || '‚Äî';
    document.getElementById('sexo').textContent = p.Sexo || '‚Äî';
    document.getElementById('diagnostico').textContent = p.DiagnosticoPrincipal || '‚Äî';
    document.getElementById('servicio').textContent = p.Servicio || '‚Äî';

    // === CONSULTAS A SUPABASE ===
    const { data: evol } = await supabase
      .from('evolucion')
      .select('*')
      .eq('PacienteID', id)
      .order('Fecha');

    const { data: meds } = await supabase
      .from('medicacion')
      .select('*')
      .eq('PacienteID', id);

    const { data: signosRaw, error: errorSignos } = await supabase
      .from('signos_vitales')
      .select('*')
      .eq('PacienteID', id);

    if (errorSignos) console.error("Error cargando signos vitales:", errorSignos);

    // === ORDENAR LOCALMENTE ===
    const signos = (signosRaw || [])
      .filter(s => s.Fecha && s.Hora)
      .sort((a, b) => {
        const f1 = new Date(`${a.Fecha}T${a.Hora}`);
        const f2 = new Date(`${b.Fecha}T${b.Hora}`);
        return f1 - f2;
      });

    // === SIGNOS VITALES ===
    if (!signos.length) {
      console.warn("‚ö†Ô∏è No hay registros de signos vitales para este paciente");
      document.getElementById('pa').textContent = '‚Äî';
      document.getElementById('fc').textContent = '‚Äî';
      document.getElementById('spo2').textContent = '‚Äî';
      document.getElementById('temp').textContent = '‚Äî';
    } else {
      const ult = signos
        .filter(s => s.PresionSistolica && s.FrecuenciaCardiaca && s.SaturacionOxigeno && s.Temperatura)
        .pop();

      if (ult) {
        document.getElementById('pa').textContent = `${ult.PresionSistolica}/${ult.PresionDiastolica}`;
        document.getElementById('fc').textContent = ult.FrecuenciaCardiaca;
        document.getElementById('spo2').textContent = ult.SaturacionOxigeno;
        document.getElementById('temp').textContent = ult.Temperatura;
      } else {
        document.getElementById('pa').textContent = '‚Äî';
        document.getElementById('fc').textContent = '‚Äî';
        document.getElementById('spo2').textContent = '‚Äî';
        document.getElementById('temp').textContent = '‚Äî';
      }

      renderConstantes(signos);
      renderHeatmap(signos);
    }

    // === EQUIPO M√âDICO ===
    const { data: notasCompletas, error: errorNotas } = await supabase
      .from("notas")
      .select("Fecha, Nota, personal_medico (Nombre, Rol)")
      .eq("PacienteID", id)
      .order("Fecha");

    if (errorNotas) console.error("Error cargando notas:", errorNotas);
    else renderNotas(notasCompletas);

    // === PRUEBAS Y RESULTADOS ===
    const { data: lab, error: errorLab } = await supabase
      .from("lab_iniciales")
      .select("Glucosa, pH, Cetonas, Creatinina, Hemoglobina, Leucocitos, Sodio, Potasio, Urea, Amilasa")
      .eq("PacienteID", id)
      .limit(1);

    if (!errorLab && lab?.length) {
      const r = lab[0];
      document.getElementById("tablaLab").innerHTML = `
        <tr><td>Glucosa</td><td>${r.Glucosa ?? "‚Äî"}</td><td>70‚Äì110 mg/dL</td></tr>
        <tr><td>pH</td><td>${r.pH ?? "‚Äî"}</td><td>7.35‚Äì7.45</td></tr>
        <tr><td>Cetonas</td><td>${r.Cetonas ?? "‚Äî"}</td><td>Negativas</td></tr>
        <tr><td>Creatinina</td><td>${r.Creatinina ?? "‚Äî"}</td><td>0.6‚Äì1.3 mg/dL</td></tr>
        <tr><td>Hemoglobina</td><td>${r.Hemoglobina ?? "‚Äî"}</td><td>12‚Äì17 g/dL</td></tr>
        <tr><td>Leucocitos</td><td>${r.Leucocitos ?? "‚Äî"}</td><td>4‚Äì11 √ó10‚Åπ/L</td></tr>
        <tr><td>Sodio</td><td>${r.Sodio ?? "‚Äî"}</td><td>135‚Äì145 mmol/L</td></tr>
        <tr><td>Potasio</td><td>${r.Potasio ?? "‚Äî"}</td><td>3.5‚Äì5.1 mmol/L</td></tr>
        <tr><td>Urea</td><td>${r.Urea ?? "‚Äî"}</td><td>10‚Äì50 mg/dL</td></tr>
        <tr><td>Amilasa</td><td>${r.Amilasa ?? "‚Äî"}</td><td>30‚Äì110 U/L</td></tr>
      `;
    }

    // === RENDER RESTANTE ===
    renderRadar(evol);
¬† ¬† renderTabla('tablaMeds', meds, ['Medicamento', 'Dosis', 'Via']);

¬† ¬† // Ejecuta ambas peticiones a la IA en paralelo
¬† ¬† await Promise.all([
¬† ¬† ¬† generarResumenIA(p, evol, signos),
¬† ¬† ¬† generarRecomendacionIA(p, evol, signos)
¬† ¬† ]);

  } catch (err) {
    console.error("‚ö†Ô∏è Error en cargar():", err);
    document.getElementById("resumenIA").textContent = "Error al cargar los datos del paciente.";
  }
}


  async function generarRecomendacionIA(p, evol, signos) {
  const barra = document.getElementById("barraProgresoRec");
  const resumenDiv = document.getElementById("resumenRec");
  resumenDiv.textContent = "Enviando datos a IA para recomendaciones...";
  barra.style.width = "0%";

  // Mismo payload que se env√≠a a /evolucion
  const payload = {
    paciente: p,
    evolucion: evol,
    signos_vitales: signos
  };

  try {
    // Endpoint de recomendaciones sigue siendo /recomendacion
    const res = await fetch("https://rubaseval.app.n8n.cloud/webhook/recomendacion", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const texto = await res.text();
    console.log("‚úÖ Respuesta Recomendaci√≥n IA:", texto);

    if (texto.trim().length > 0) {
¬† ¬† ¬† barra.style.width = "100%";
      
      // Convertimos **texto** a <strong style="color:var(--azul);>texto</strong>
¬† ¬† ¬† const textoHtml = texto.replace(
        /\*\*(.*?)\*\*/g, 
        '<strong style="color:var(--azul);">$1</strong>'
      );
      
¬† ¬† ¬† resumenDiv.innerHTML = `<div style="white-space: pre-wrap;">${textoHtml}</div>`;
¬† ¬† } else {
      resumenDiv.textContent = "‚ö†Ô∏è La IA no devolvi√≥ texto.";
    }

  } catch (err) {
    console.error("‚ùå Error Recomendaci√≥n IA:", err);
    resumenDiv.textContent = "Error al conectar con el asistente IA.";
  }
}


/* === RADAR === */
function renderRadar(evol) {
  if (!evol?.length) return;
  const ingreso = evol[0];
  const alta = evol[evol.length - 1];

  const ctx = document.getElementById("graficoRadar");

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: [
        "Presi√≥n Sist√≥lica (mmHg)",
        "Frecuencia Cardiaca (bpm)",
        "Saturaci√≥n O‚ÇÇ (%)",
        "Glucosa (mg/dl)"
      ],
      datasets: [
        {
          label: "Ingreso",
          data: [
            ingreso.PresionSistolica,
            ingreso.FrecuenciaCardiaca,
            ingreso.SaturacionOxigeno,
            ingreso.Glucosa
          ],
          backgroundColor: "rgba(0, 74, 173, 0.7)",
          borderRadius: 6
        },
        {
          label: "Alta",
          data: [
            alta.PresionSistolica,
            alta.FrecuenciaCardiaca,
            alta.SaturacionOxigeno,
            alta.Glucosa
          ],
          backgroundColor: "rgba(22, 163, 74, 0.7)",
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        x: {
          ticks: { font: { size: 12 } },
          grid: { display: false }
        },
        y: {
          beginAtZero: false,
          ticks: { font: { size: 12 } },
          title: {
            display: true,
            text: "Valor",
            font: { weight: "bold" }
          }
        }
      },
      plugins: {
        legend: {
          position: "bottom",
          labels: { font: { size: 13, weight: "600" } }
        },
        title: {
          display: false,
          text: "Comparativa de signos vitales (Ingreso vs Alta)",
          font: { size: 16, weight: "bold" }
        }
      }
    }
  });
}


/* === TABLAS === */
function renderTabla(id, datos, columnas) {
  document.getElementById(id).innerHTML = datos?.length
    ? datos.map(d => `<tr>${columnas.map(c => `<td>${d[c] ?? '-'}</td>`).join('')}</tr>`).join('')
    : `<tr><td colspan="${columnas.length}">Sin registros</td></tr>`;
}

/* === RESUMEN IA === */
async function generarResumenIA(p, evol, signos) {
  const barra = document.getElementById("barraProgreso");
  const resumenDiv = document.getElementById("resumenIA");
  resumenDiv.textContent = "Enviando datos a IA...";
  barra.style.width = "0%";

  // Preparar payload con toda la info del paciente
  const payload = {
    paciente: p,
    evolucion: evol,
    signos_vitales: signos
  };

  try {
    const res = await fetch("https://rubaseval.app.n8n.cloud/webhook/evolucion", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const texto = await res.text();
    console.log("‚úÖ Respuesta IA:", texto);

    if (texto.trim().length > 0) {
¬† ¬† ¬† barra.style.width = "100%";
      
      // Convertimos **texto** a <strong style="color:var(--azul);>texto</strong>
¬† ¬† ¬† const textoHtml = texto.replace(
        /\*\*(.*?)\*\*/g, 
        '<strong style="color:var(--azul);">$1</strong>'
      );

¬† ¬† ¬† resumenDiv.innerHTML = `<div style="white-space: pre-wrap;">${textoHtml}</div>`;
¬† ¬† } else {
      resumenDiv.textContent = "‚ö†Ô∏è La IA no devolvi√≥ texto.";
    }

  } catch (err) {
    console.error("‚ùå Error IA:", err);
    resumenDiv.textContent = "Error al conectar con el asistente IA.";
  }
}

function activarValoracion() {
  const stars = document.getElementById("stars");
  stars.addEventListener("click", e => {
    let n = Math.ceil(e.offsetX / (stars.offsetWidth / 5));
    stars.innerHTML = "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0,n) + "<span style='color:#ccc;'>" + "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(n) + "</span>";
    console.log(`‚≠ê Valoraci√≥n: ${n}/5`);
  });
}


/* === GRAFICO DE CONSTANTES VITALES === */
function renderConstantes(signos) {
  if (!signos?.length) return;
  const zona = document.getElementById("zonaGraficos");

  // Crear contenedor del gr√°fico
  const cont = document.createElement("div");
  cont.style.marginTop = "20px";

  // T√≠tulo con el mismo formato que el del mapa de calor
  // T√≠tulo con el mismo formato que el del mapa de calor
  cont.innerHTML = `
    <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-2 text-center border-b-2 border-blue-300 pb-2">
      Constantes vitales durante la estancia
    </h3>
    <canvas id="graficoConstantes" style="width:100%;max-width:600px;height:260px;max-height:260px;"></canvas>
  `;

  zona.appendChild(cont);

  const ctx = document.getElementById("graficoConstantes");

  const fechas = signos.map(s => new Date(s.Fecha).toLocaleDateString());
  const fc = signos.map(s => s.FrecuenciaCardiaca);
  const temp = signos.map(s => s.Temperatura);

  new Chart(ctx, {
    type: "line",
    data: {
      labels: fechas,
      datasets: [
        { label: "FC (bpm)", data: fc, borderColor: "#3a6ff8", borderWidth: 2, fill: false },
        { label: "Temperatura (¬∞C)", data: temp, borderColor: "#f39c12", borderWidth: 2, fill: false }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: false } },
      plugins: { legend: { position: "bottom" } }
    }
  });
}

function renderHeatmap(signos) {
  if (!signos?.length) return;

  const zona = document.getElementById("zonaGraficos");

  // Contenedor del gr√°fico
  const cont = document.createElement("div");
  cont.style.marginTop = "20px";

  // T√≠tulo y canvas
  cont.innerHTML = `
    <h3>Mapa de calor de signos vitales</h3>
    <canvas id="graficoHeat"></canvas>
    <div style="font-size:12px; margin-top:5px; text-align:center;">
      <span style="background:#16a34a; color:white; padding:2px 6px; border-radius:4px;">Normal</span>
      <span style="background:#f59e0b; color:white; padding:2px 6px; border-radius:4px;">L√≠mite</span>
      <span style="background:#dc2626; color:white; padding:2px 6px; border-radius:4px;">Cr√≠tico</span>
    </div>
  `;
  zona.appendChild(cont);

  const ctx = document.getElementById("graficoHeat");

  // Par√°metros y fechas
  const parametros = ["Presi√≥n Sist√≥lica", "FC", "Temperatura", "SpO‚ÇÇ"];
  const fechas = signos.map(s => new Date(s.Fecha).toLocaleDateString());

  // Rangos normales
  const normal = {
  "Presi√≥n Sist√≥lica": { min: 110, max: 130 },
  "FC": { min: 65, max: 90 },
  "Temperatura": { min: 36.2, max: 37.2 },
  "SpO‚ÇÇ": { min: 96, max: 99 }
  };

  // Datos para el heatmap
  const valores = signos.flatMap((s, i) => [
    { x: i, y: 0, v: s.PresionSistolica },
    { x: i, y: 1, v: s.FrecuenciaCardiaca },
    { x: i, y: 2, v: s.Temperatura },
    { x: i, y: 3, v: s.SaturacionOxigeno }
  ]);

  // Render del gr√°fico
  new Chart(ctx, {
    type: 'matrix',
    data: {
      datasets: [{
        label: 'Signos vitales',
        data: valores,
        backgroundColor: ctx => {
          const { v, y } = ctx.raw;
          const param = parametros[y];
          const { min, max } = normal[param];
          if (v < min) return "rgba(220,38,38,0.85)";    // rojo cr√≠tico
          if (v > max) return "rgba(245,158,11,0.85)";   // naranja l√≠mite
          return "rgba(22,163,74,0.85)";                 // verde normal
        },
        borderWidth: 1,
        borderColor: "#fff",
        width: ctx => {
          const chart = ctx.chart;
          const area = chart.chartArea || {};
          const xCount = fechas.length;
          return area.width ? area.width / xCount - 3 : chart.width / xCount - 3;
        },
        height: ctx => {
          const chart = ctx.chart;
          const area = chart.chartArea || {};
          const yCount = parametros.length;
          return area.height ? area.height / yCount - 3 : chart.height / yCount - 3;
        }
      }]
    },
    options: {
      layout: { padding: { top: 10, bottom: 10 } },
      plugins: {
        tooltip: {
          callbacks: {
            title: ctx => `${parametros[ctx[0].raw.y]} ‚Äî ${fechas[ctx[0].raw.x]}`,
            label: ctx => `Valor: ${ctx.raw.v}`
          }
        },
        legend: { display: false },
        title: { display: false }
      },
      scales: {
        x: {
          offset: true,
          ticks: {
            callback: v => fechas[v] || "",
            maxRotation: 60,
            minRotation: 60,
            font: { size: 9 }
          },
          grid: { display: false }
        },
        y: {
          ticks: {
            callback: v => parametros[v] || "",
            font: { size: 10 }
          },
          grid: { display: false }
        }
      }


    }
  });
}

function renderNotas(notas) {
  const tabla = document.getElementById("tablaMedicos");
  if (!notas?.length) {
    tabla.innerHTML = `<tr><td colspan="3">Sin notas registradas</td></tr>`;
    return;
  }

  tabla.innerHTML = notas.map(n => `
    <tr>
      <td>${n.personal_medico?.Nombre || "‚Äî"}</td>
      <td>${n.personal_medico?.Rol || "‚Äî"}</td>
      <td>
        <div style="font-size:0.75rem; color:#555;">${new Date(n.Fecha).toLocaleDateString()}</div>
        <div style="font-size:0.8rem;">${n.Nota}</div>
      </td>
    </tr>
  `).join('');
}

async function generarPDF() {
  const { jsPDF } = window.jspdf;
  const contenedor = document.getElementById("panel");

  const canvas = await html2canvas(contenedor, { scale: 2, useCORS: true });
  const imgData = canvas.toDataURL("image/png");

  const pdf = new jsPDF("p", "mm", "a4");
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  const imgWidth = pageWidth;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;

  if (imgHeight <= pageHeight) {
    pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
  } else {
    let position = 0;
    while (position < imgHeight) {
      pdf.addImage(imgData, "PNG", 0, -position, imgWidth, imgHeight);
      position += pageHeight;
      if (position < imgHeight) pdf.addPage();
    }
  }

  // üß† Recuperar el usuario del login
  const usuario = JSON.parse(localStorage.getItem("usuario")) || {};
  const medicoNombre = usuario.Nombre || usuario.nombre || "M√©dico desconocido";
  const medicoEmail = usuario.correo_login || usuario.email || "correo no disponible";

  const nombrePaciente = document.getElementById("nombre")?.innerText || "resumen_paciente";
  const fechaActual = new Date().toLocaleString();

  // Pie de p√°gina con usuario y correo
  pdf.setFontSize(9);
  pdf.text(
    `Generado por: ${medicoNombre} (${medicoEmail}) ‚Äî ${fechaActual}`,
    pageWidth / 2,
    pageHeight - 10,
    { align: "center" }
  );

  pdf.save(`${nombrePaciente}_informe.pdf`);
}

// Necesario porque el script es m√≥dulo
window.generarPDF = generarPDF;

// === REGISTRO DEL PLUGIN MATRIX ===
if (window['chartjs-chart-matrix']) {
  Chart.register(window['chartjs-chart-matrix']);
  console.log("‚úÖ Plugin Matrix 3.0.0 registrado correctamente");
} else {
  console.warn("‚ö†Ô∏è chartjs-chart-matrix no encontrado. Revisa la ruta del script.");
}


cargar();
</script>
</body>
