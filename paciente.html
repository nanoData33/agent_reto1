<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel ClÃ­nico Interactivo</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #f5f9ff;
      margin: 0;
      color: #1a1a1a;
      overflow: hidden;
    }

    header {
      background: #004aad;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.5em;
    }

    header button {
      background: #ffffff22;
      border: 1px solid #fff;
      border-radius: 8px;
      padding: 6px 14px;
      color: white;
      cursor: pointer;
    }

    .container {
      display: grid;
      grid-template-rows: auto 1fr;
      height: calc(100vh - 60px);
      padding: 10px 25px;
      gap: 10px;
    }

    .info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      background: white;
      border-radius: 10px;
      padding: 10px 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .info-item {
      background: #f1f5ff;
      border-radius: 6px;
      padding: 6px 8px;
      font-size: 0.9em;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 15px;
    }

    .charts {
      background: white;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      gap: 10px;
      justify-content: space-around;
      align-items: center;
    }

    canvas {
      flex: 1;
      height: 270px !important;
    }

    .tabs {
      background: white;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }

    .tab-buttons {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .tab-buttons button {
      background: #eef2ff;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.9em;
    }

    .tab-buttons button.active {
      background: #004aad;
      color: white;
    }

    .tab-content {
      overflow-y: auto;
      font-size: 0.9em;
      height: 250px;
    }

    .highlight {
      background: #f7faff;
      border-left: 4px solid #004aad;
      padding: 6px 8px;
      margin-bottom: 8px;
      border-radius: 6px;
    }

  </style>
</head>
<body>
  <header>
    <button onclick="window.location.href='index.html'">â¬… Volver</button>
    <h1 id="nombre">Cargando...</h1>
    <button id="pdfBtn">ðŸ“„ PDF</button>
  </header>

  <div class="container">
    <div class="info" id="info"></div>

    <div class="dashboard">
      <div class="charts">
        <canvas id="radarChart"></canvas>
        <canvas id="vitalChart"></canvas>
      </div>

      <div class="tabs">
        <div class="tab-buttons">
          <button class="active" onclick="showTab('evolucion')">EvoluciÃ³n</button>
          <button onclick="showTab('tratamientos')">Tratamientos</button>
          <button onclick="showTab('resultados')">Resultados</button>
          <button onclick="showTab('alta')">Alta</button>
        </div>

        <div class="tab-content" id="evolucion"></div>
        <div class="tab-content" id="tratamientos" style="display:none"></div>
        <div class="tab-content" id="resultados" style="display:none"></div>
        <div class="tab-content" id="alta" style="display:none"></div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://aczjgeleupwlvghjhkav.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjempnZWxldXB3bHZnaGpoa2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzgwODMsImV4cCI6MjA3NjU1NDA4M30.-hQdLNDMw-i4vCpt_OXnzYss5MtVrCu76FhMCPcZPhM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const id = new URLSearchParams(window.location.search).get("id");

    async function loadData() {
      const { data: p } = await supabase.from("paciente").select("*").eq("patient_id", id).single();
      document.getElementById("nombre").textContent = p.nombre;
      document.getElementById("info").innerHTML = `
        <div class="info-item"><strong>Edad:</strong> ${p.edad}</div>
        <div class="info-item"><strong>Sexo:</strong> ${p.sexo}</div>
        <div class="info-item"><strong>Peso:</strong> ${p.peso_kg} kg</div>
        <div class="info-item"><strong>Altura:</strong> ${p.altura_cm} cm</div>
        <div class="info-item"><strong>IMC:</strong> ${p.imc}</div>
        <div class="info-item"><strong>Motivo:</strong> ${p.motivo_ingreso}</div>
        <div class="info-item"><strong>Servicio:</strong> ${p.servicio}</div>
        <div class="info-item"><strong>Ingreso:</strong> ${p.fecha_ingreso}</div>
      `;

      // EvoluciÃ³n mÃ©dica
      const { data: evol } = await supabase.from("evolucion_medica").select("*").eq("patient_id", id).order("fecha", { ascending: false });
      const evolContent = evol.map(e => `
        <div class="highlight">
          <strong>${e.fecha}</strong> â€” ${e.estado_general || "Sin estado"}<br>
          <em>${e.nota_medica}</em><br>
          <small>Dolor ${e.dolor_nivel}/10 | SueÃ±o ${e.sueÃ±o_calidad}/10 | Movilidad ${e.movilidad}/10</small>
        </div>`).join("");
      document.getElementById("evolucion").innerHTML = evolContent;

      // Radar Chart
      const first = evol[evol.length - 1], last = evol[0];
      new Chart(document.getElementById("radarChart"), {
        type: "radar",
        data: {
          labels: ["Dolor", "Movilidad", "Apetito", "SueÃ±o", "Tolerancia"],
          datasets: [
            {
              label: `Ingreso (${first.fecha})`,
              data: [first.dolor_nivel, first.movilidad, first.apetito, first.sueÃ±o_calidad, first.tolerancia_tratamiento],
              backgroundColor: "rgba(255,99,132,0.2)",
              borderColor: "#ff6384"
            },
            {
              label: `Actual (${last.fecha})`,
              data: [last.dolor_nivel, last.movilidad, last.apetito, last.sueÃ±o_calidad, last.tolerancia_tratamiento],
              backgroundColor: "rgba(54,162,235,0.2)",
              borderColor: "#36a2eb"
            }
          ]
        },
        options: { scales: { r: { beginAtZero: true, max: 10 } } }
      });

      // Resultados clÃ­nicos
      const { data: res } = await supabase.from("resultados_clinicos").select("*").eq("patient_id", id).order("fecha", { ascending: true });
      const vitalChart = new Chart(document.getElementById("vitalChart"), {
        type: "line",
        data: {
          labels: res.map(r => r.fecha),
          datasets: [
            { label: "Temperatura", data: res.map(r => r.temperatura), borderColor: "#ff9f40" },
            { label: "FC", data: res.map(r => r.frecuencia_cardiaca), borderColor: "#4bc0c0" },
            { label: "SpOâ‚‚", data: res.map(r => r.spo2), borderColor: "#9966ff" }
          ]
        },
        options: { plugins: { legend: { position: "bottom" } } }
      });

      document.getElementById("resultados").innerHTML = res.map(r => `
        <div class="highlight">
          <strong>${r.fecha}</strong> â€” Temp ${r.temperatura}Â°C, FC ${r.frecuencia_cardiaca}, SpOâ‚‚ ${r.spo2}%
        </div>
      `).join("");

      // Tratamientos
      const { data: trat } = await supabase.from("tratamientos").select("*").eq("patient_id", id);
      document.getElementById("tratamientos").innerHTML = trat.map(t => `
        <div class="highlight">
          <strong>${t.tratamiento}</strong> (${t.via_administracion})<br>
          ${t.procedimientos || ""}<br>
          <small>${t.efectos_secundarios || ""}</small>
        </div>`).join("");

      // Alta
      const { data: alta } = await supabase.from("alta_resumen").select("*").eq("patient_id", id).single();
      document.getElementById("alta").innerHTML = alta ? `
        <p><strong>DiagnÃ³stico:</strong> ${alta.diagnostico_principal}</p>
        <p><strong>Resumen:</strong> ${alta.evolucion_resumen}</p>
        <p><strong>Tratamiento:</strong> ${alta.tratamiento_alta}</p>
        <p><strong>Seguimiento:</strong> ${alta.seguimiento_recomendado}</p>
      ` : "<em>Sin datos de alta</em>";
    }

    function showTab(tabId) {
      document.querySelectorAll(".tab-content").forEach(t => t.style.display = "none");
      document.querySelectorAll(".tab-buttons button").forEach(b => b.classList.remove("active"));
      document.getElementById(tabId).style.display = "block";
      event.target.classList.add("active");
    }

    loadData();
  </script>
</body>
</html>
