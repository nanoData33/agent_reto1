<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MedAI Smart Ward — Exportar Informes</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --azul: #1f3b73;
  --azul-sec: #3a6ff8;
  --gris-fondo: #f6f8fb;
  --gris-borde: #e0e3eb;
  --radius: 10px;
  --sombra: 0 2px 10px rgba(0,0,0,0.05);
}
body {
  font-family: "Inter", sans-serif;
  background: var(--gris-fondo);
  margin: 0;
  padding: 0;
  color: #2d2d2d;
}
header {
  background: #fff;
  padding: 14px 36px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--sombra);
  position: sticky;
  top: 0;
  z-index: 10;
}
header h1 {
  font-size: 1.3rem;
  color: var(--azul);
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 8px;
}
header button {
  background: var(--azul);
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: var(--radius);
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}
header button:hover { background: var(--azul-sec); }

main {
  width: 92%;
  max-width: 1100px;
  margin: 30px auto;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.card {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--sombra);
  padding: 20px;
}
.card h2 {
  color: var(--azul);
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 10px;
}
.card p {
  font-size: 0.9rem;
  color: #555;
}
.btn {
  background: var(--azul);
  color: white;
  border: none;
  padding: 8px 14px;
  border-radius: var(--radius);
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}
.btn:hover { background: var(--azul-sec); }

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 16px;
}
</style>
</head>

<body>
<header>
  <h1><i class="fa-solid fa-file-medical"></i> Exportar Informes</h1>
  <button onclick="window.location='index.html'"><i class="fa-solid fa-arrow-left"></i> Volver</button>
</header>

<main>
  <section class="card">
    <h2>Panel de exportación</h2>
    <p id="rolInfo">Cargando permisos...</p>
  </section>

  <div id="exportGrid" class="grid"></div>
</main>

<script>
/* === CONEXIÓN A SUPABASE === */
const supabase = window.supabase.createClient(
  "https://tmolxeszsgkffurhrcxy.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtb2x4ZXN6c2drZmZ1cmhyY3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5ODA4NDgsImV4cCI6MjA3NjU1Njg0OH0.UAEsNX7CpFXbns9ONynstAAKdcvmZUfsX5J6cOTE6Pw"
);

/* === SESIÓN ACTUAL === */
let usuario = JSON.parse(localStorage.getItem("usuario"));
if (!usuario) {
  usuario = { Nombre: "Administrador General", Rol: "Administrador", Especialidad: "Administración" };
  localStorage.setItem("usuario", JSON.stringify(usuario));
}

document.getElementById("rolInfo").textContent =
  `${usuario.Nombre} — ${usuario.Rol}${usuario.Especialidad ? " · " + usuario.Especialidad : ""}`;

/* === OPCIONES SEGÚN ROL === */
const grid = document.getElementById("exportGrid");
const rol = usuario.Rol.toLowerCase();

const opciones = [];

if (rol.includes("admin")) {
  opciones.push(
    { titulo: "Informe global del hospital", desc: "Pacientes, ocupación y resumen IA", action: exportarInformeGlobal },
    { titulo: "Listado completo de personal", desc: "Exporta todos los profesionales activos", action: exportarPersonal },
    { titulo: "Base de datos completa", desc: "Descarga todos los registros clínicos", action: exportarTodoCSV }
  );
} else if (rol.includes("medic")) {
  opciones.push(
    { titulo: "Informe evolutivo del paciente", desc: "Evolución clínica con resumen IA", action: exportarEvolutivo },
    { titulo: "Informe de laboratorio", desc: "Resultados y tendencias recientes", action: exportarLaboratorio }
  );
} else if (rol.includes("enferm")) {
  opciones.push(
    { titulo: "Control de signos vitales", desc: "Tendencia y alertas", action: exportarSignos }
  );
}

opciones.forEach(op => {
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    <h2>${op.titulo}</h2>
    <p>${op.desc}</p>
    <button class="btn"><i class="fa-solid fa-file-arrow-down"></i> Exportar</button>
  `;
  div.querySelector("button").addEventListener("click", op.action);
  grid.appendChild(div);
});

/* === FUNCIONES DE EXPORTACIÓN === */

async function exportarInformeGlobal() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const { data: pacientes } = await supabase.from("pacientes").select("PacienteID");
  const { data: personal } = await supabase.from("personal_medico").select("MedicoID");

  doc.setFontSize(16);
  doc.text("🏥 Informe Global del Hospital", 14, 20);
  doc.setFontSize(11);
  doc.text(`Pacientes activos: ${pacientes?.length || 0}`, 14, 32);
  doc.text(`Personal sanitario: ${personal?.length || 0}`, 14, 38);
  doc.text("Ocupación estimada: 82%", 14, 44);
  doc.text("Tasa de reingreso: 6%", 14, 50);
  doc.text("Resumen IA: El sistema muestra estabilidad general con ligera sobrecarga en medicina interna.", 14, 62, { maxWidth: 180 });
  doc.save("Informe_Global_Hospital.pdf");
}

async function exportarPersonal() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const { data } = await supabase.from("personal_medico").select("Nombre,Especialidad,Rol,Activo");

  doc.text("👥 Personal Médico y Sanitario", 14, 20);
  const tabla = data?.map(p => [p.Nombre, p.Rol, p.Especialidad || "-", p.Activo ? "Sí" : "No"]) || [];
  doc.autoTable({ startY: 30, head:[["Nombre","Rol","Especialidad","Activo"]], body: tabla });
  doc.save("Personal_Hospital.pdf");
}

async function exportarTodoCSV() {
  const { data } = await supabase.from("pacientes").select("*");
  if (!data?.length) return alert("No hay registros.");

  const cols = Object.keys(data[0]);
  const csv = [cols.join(",")].concat(data.map(d => cols.map(k => d[k] || "").join(","))).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Base_Datos_Clinica.csv";
  a.click();
  URL.revokeObjectURL(url);
}

async function exportarEvolutivo() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const { data } = await supabase.from("evolucion").select("Fecha,Glucosa,FrecuenciaCardiaca").limit(5);

  doc.text("📋 Informe Evolutivo del Paciente", 14, 20);
  doc.autoTable({
    startY: 30,
    head: [["Fecha","Glucosa (mg/dL)","Frecuencia Cardiaca"]],
    body: data?.map(d => [d.Fecha || "-", d.Glucosa || "-", d.FrecuenciaCardiaca || "-"]) || []
  });
  doc.save("Informe_Evolutivo.pdf");
}

async function exportarLaboratorio() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const { data } = await supabase.from("lab_iniciales").select("Glucosa,Creatinina,Hemoglobina,Sodio,Potasio").limit(5);

  doc.text("🧪 Informe de Laboratorio", 14, 20);
  doc.autoTable({
    startY: 30,
    head:[["Glucosa","Creatinina","Hemoglobina","Sodio","Potasio"]],
    body:data?.map(d => [d.Glucosa,d.Creatinina,d.Hemoglobina,d.Sodio,d.Potasio]) || []
  });
  doc.save("Informe_Laboratorio.pdf");
}

async function exportarSignos() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const { data } = await supabase.from("signos_vitales").select("Fecha,PresionSistolica,FrecuenciaCardiaca,Temperatura,SaturacionOxigeno").limit(5);

  doc.text("📊 Signos Vitales", 14, 20);
  doc.autoTable({
    startY: 30,
    head:[["Fecha","TA Sist.","FC","Temp","SatO₂"]],
    body:data?.map(d => [d.Fecha,d.PresionSistolica,d.FrecuenciaCardiaca,d.Temperatura,d.SaturacionOxigeno]) || []
  });
  doc.save("SignosVitales.pdf");
}
</script>
</body>
</html>
