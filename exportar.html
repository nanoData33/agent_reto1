<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>MedAI Smart Ward — Exportar Informes</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root {
  --blue-main:#1f3b73;
  --blue-accent:#3a6ff8;
  --gray-bg:#f4f7fc;
  --gray-dark:#2d2d2d;
  --gray-mid:#666;
  --radius:10px;
  --shadow:0 3px 10px rgba(0,0,0,0.08);
  --transition:all 0.3s ease;
}
body{margin:0;font-family:"Inter",sans-serif;background:var(--gray-bg);color:var(--gray-dark);min-height:100vh;display:flex;flex-direction:column;}
header{background:#fff;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:14px 40px;}
header span{font-weight:700;font-size:1.3rem;color:var(--blue-main);display:flex;align-items:center;gap:10px}
section{width:94%;max-width:1100px;margin:30px auto;}
.card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin-bottom:20px;}
h2{color:var(--blue-main);margin-bottom:14px;font-size:1.3rem}
button{background:var(--blue-main);color:white;border:none;padding:8px 14px;border-radius:var(--radius);font-weight:600;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:6px;font-size:.9rem}
button:hover{background:var(--blue-accent);transform:translateY(-2px)}
#logout-btn{background:#c0392b}#logout-btn:hover{background:#a93226}
.user-chip{background:#eef3ff;color:#1f3b73;border:1px solid #d8e2ff;padding:6px 10px;border-radius:999px;font-weight:600;font-size:.9rem}
.list{display:grid;gap:10px;}
.option{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#f9fafc;border-radius:var(--radius);border-left:4px solid var(--blue-main);}
.option:hover{background:#eef2ff;}
#msg{color:#555;margin-top:20px;font-size:.9rem}
</style>
</head>

<body>
<header>
  <span><i class="fa-solid fa-file-export"></i> Exportar Informes</span>
  <span id="user-info" class="user-chip"></span>
  <button id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión</button>
</header>

<section>
  <div class="card">
    <h2>Exportaciones disponibles</h2>
    <p class="text-gray-600 mb-4">Selecciona el tipo de informe que deseas generar en formato PDF.</p>
    <div class="list" id="export-list"></div>
    <div id="msg"></div>
  </div>
</section>

<script>
const usuario = JSON.parse(localStorage.getItem("usuario"));
if (!usuario) window.location.href = "login.html";

const { jsPDF } = window.jspdf;
const supabase = window.supabase.createClient(
  "https://aczjgeleupwlvghjhkav.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjempnZWxldXB3bHZnaGpoa2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzgwODMsImV4cCI6MjA3NjU1NDA4M30.-hQdLNDMw-i4vCpt_OXnzYss5MtVrCu76FhMCPcZPhM"
);

const chip = document.getElementById("user-info");
if (chip && usuario) {
  const rol = usuario.Rol || "—";
  const nombre = usuario.Nombre || "Usuario";
  const esp = usuario.Especialidad || "";
  chip.textContent = `${nombre} (${rol}${esp ? " · " + esp : ""})`;
}

const exportList = document.getElementById("export-list");
const opciones = [
  { id: "pacientes", texto: "Informe de pacientes del servicio", icon: "fa-user-injured" },
  { id: "evolucion", texto: "Evolución clínica detallada", icon: "fa-chart-line" },
  { id: "medicacion", texto: "Listado de medicaciones activas", icon: "fa-pills" },
  { id: "personal", texto: "Personal médico activo", icon: "fa-user-doctor" },
  { id: "actividad", texto: "Resumen de actividad del servicio", icon: "fa-hospital-user" }
];
exportList.innerHTML = opciones.map(o =>
  `<div class='option'><div><i class='fa-solid ${o.icon} text-[var(--blue-main)]'></i> ${o.texto}</div>
   <button onclick="generarPDF('${o.id}')"><i class='fa-solid fa-file-pdf'></i> Exportar</button></div>`).join("");

async function generarPDF(tipo) {
  const rol = usuario.Rol;
  const especialidad = usuario.Especialidad;
  const nombre = usuario.Nombre;
  const doc = new jsPDF();
  let title = "Informe Médico";
  let content = [];

  document.getElementById("msg").innerText = "Generando informe, espera unos segundos...";

  try {
    if (tipo === "pacientes") {
      const { data } = await supabase.from("pacientes").select("*").limit(50);
      title = `Pacientes del servicio: ${especialidad}`;
      content = data.filter(p => rol==="Administrador" || p.Servicio === especialidad)
                    .map(p => `${p.Nombre} — ${p.DiagnosticoPrincipal || "Sin diagnóstico"} (${p.Servicio})`);
    }

    if (tipo === "evolucion") {
      const { data } = await supabase.from("evolucion").select("*").limit(30);
      title = "Evolución clínica general (últimos registros)";
      content = data.slice(0, 30).map(e => `${e.PacienteID} — T: ${e.Temperatura}°C, FC: ${e.FrecuenciaCardiaca}, SpO2: ${e.SaturacionOxigeno}%`);
    }

    if (tipo === "medicacion") {
      const { data } = await supabase.from("medicacion").select("*").limit(50);
      title = "Listado de medicaciones activas";
      content = data.map(m => `${m.Medicamento} — ${m.Dosis} (${m.Via})`);
    }

    if (tipo === "personal") {
      const { data } = await supabase.from("personal_medico").select("*").eq("Activo", true);
      title = "Personal médico activo";
      content = data.map(p => `${p.Nombre} — ${p.Especialidad} (${p.Rol})`);
    }

    if (tipo === "actividad") {
      const { data: notas } = await supabase.from("notas").select("*").limit(30);
      title = `Resumen de actividad — ${especialidad}`;
      content = notas.map(n => `${n.Fecha} — ${n.Nota.substring(0, 60)}...`);
    }

    // === Generar PDF ===
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text(title, 15, 20);
    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);
    doc.text(`Generado por: ${nombre} (${rol}${especialidad ? " · " + especialidad : ""})`, 15, 30);
    doc.line(15, 33, 195, 33);

    let y = 45;
    content.forEach((linea, i) => {
      if (y > 280) { doc.addPage(); y = 20; }
      doc.text(`${i+1}. ${linea}`, 15, y);
      y += 8;
    });

    doc.setFontSize(10);
    doc.setTextColor(120);
    doc.text("MedAI Smart Ward — Informe automático", 15, 290);
    doc.save(`${tipo}_${Date.now()}.pdf`);
    document.getElementById("msg").innerText = "Informe descargado correctamente.";
  } catch (err) {
    console.error(err);
    document.getElementById("msg").innerText = "Error al generar el informe.";
  }
}

document.getElementById("logout-btn").addEventListener("click", async () => {
  await supabase.auth.signOut();
  localStorage.clear();
  window.location.href = "login.html";
});
</script>
</body>
</html>
