<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Exportar Informes — MedAI Smart Ward</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --blue-main: #1f3b73;
      --blue-accent: #3a6ff8;
      --gray-bg: #f4f7fc;
      --gray-dark: #2d2d2d;
      --radius: 10px;
      --shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    body {
      font-family: "Inter", sans-serif;
      background: var(--gray-bg);
      color: var(--gray-dark);
      margin: 0;
      min-height: 100vh;
    }

    header {
      background: #fff;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 40px;
    }

    header span {
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--blue-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    main {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    h2 {
      color: var(--blue-main);
      margin-bottom: 20px;
    }

    button {
      background: var(--blue-main);
      color: white;
      border: none;
      padding: 10px 18px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.25s;
      margin-right: 10px;
    }
    button:hover {
      background: var(--blue-accent);
      transform: translateY(-2px);
    }

    .acciones-pdf {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin: 40px auto 10px;
    }

    .btn-volver {
      background: var(--blue-main);
      color: white;
    }
    .btn-volver:hover {
      background: var(--blue-accent);
    }

    .btn-cerrar {
      background: #c0392b;
      color: white;
    }
    .btn-cerrar:hover {
      background: #a93226;
    }

    @media (max-width: 640px) {
      main {
        width: 90%;
      }
      .acciones-pdf {
        flex-direction: column;
        align-items: center;
      }
      .btn-volver, .btn-cerrar {
        width: 90%;
      }
    }
  </style>
</head>

<body>
  <header>
    <span><i class="fa-solid fa-file-medical"></i> MedAI Smart Ward — Exportar Informes</span>
    <span id="user-info"></span>
  </header>

  <main>
    <h2><i class="fa-solid fa-notes-medical"></i> Exportación de Informes Clínicos</h2>
    <p>Selecciona el tipo de informe que deseas generar según tu rol y especialidad:</p>

    <div style="margin-top: 20px;">
      <button onclick="generarPDF('signos_vitales')"><i class="fa-solid fa-heart-pulse"></i> Evolución Clínica</button>
      <button onclick="generarPDF('medicacion')"><i class="fa-solid fa-pills"></i> Medicación</button>
      <button onclick="generarPDF('lab_iniciales')"><i class="fa-solid fa-flask"></i> Laboratorios</button>
    </div>
  </main>

  <div class="acciones-pdf">
    <button class="btn-volver" onclick="window.location.href='index.html'">
      <i class="fa-solid fa-arrow-left"></i> Volver al inicio
    </button>
    <button class="btn-cerrar" id="cerrar-sesion-btn">
      <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
    </button>
  </div>

  <script>
    const { jsPDF } = window.jspdf;

    const SUPABASE_URL = "https://aczjgeleupwlvghjhkav.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjempnZWxldXB3bHZnaGpoa2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzgwODMsImV4cCI6MjA3NjU1NDA4M30.-hQdLNDMw-i4vCpt_OXnzYss5MtVrCu76FhMCPcZPhM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const usuario = JSON.parse(localStorage.getItem("usuario"));
    if (!usuario) window.location.href = "login.html";
    document.getElementById("user-info").textContent = `${usuario.Nombre} (${usuario.Rol} · ${usuario.Especialidad})`;

    async function generarPDF(tipo) {
      let titulo = "";
      let query = "";
      switch (tipo) {
        case "signos_vitales":
          titulo = "Evolución Clínica";
          query = "signos_vitales";
          break;
        case "medicacion":
          titulo = "Registro de Medicación";
          query = "medicacion";
          break;
        case "lab_iniciales":
          titulo = "Resultados de Laboratorio Iniciales";
          query = "lab_iniciales";
          break;
      }

      const { data, error } = await supabase.from(query).select("*");
      if (error) {
        alert("Error al obtener datos");
        return;
      }

      const filtro = usuario.Rol === "Administrador" ? data :
        data.filter(d => d.Servicio === usuario.Especialidad || d.especialidad === usuario.Especialidad);

      const agrupado = {};
      filtro.forEach(r => {
        const pid = r.PacienteID || "Desconocido";
        if (!agrupado[pid]) agrupado[pid] = [];
        agrupado[pid].push(r);
      });

      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const fecha = new Date().toLocaleDateString();

      // CABECERA
      doc.setFillColor(31, 59, 115);
      doc.rect(0, 0, 595, 70, "F");
      doc.setFont("helvetica", "bold");
      doc.setFontSize(16);
      doc.setTextColor(255, 255, 255);
      doc.text("MedAI Smart Ward", 40, 40);

      // Icono hospital
      doc.setDrawColor(255, 255, 255);
      doc.circle(550, 35, 10, "S");

      doc.setTextColor(31, 59, 115);
      doc.setFontSize(14);
      doc.text(titulo, 40, 110);
      doc.setFontSize(10);
      doc.text(`Generado por: Dr./Dra. ${usuario.Nombre} (${usuario.Especialidad})`, 40, 130);
      doc.text(`Fecha: ${fecha}`, 450, 130);
      doc.line(40, 135, 550, 135);

      let y = 160;

      for (const [paciente, registros] of Object.entries(agrupado)) {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text(`Paciente ${paciente}`, 40, y);
        y += 10;

        const columnas = Object.keys(registros[0]).filter(k => !["id", "MedicoID"].includes(k));
        const filas = registros.map(r => columnas.map(c => r[c] ?? "-"));

        doc.autoTable({
          startY: y + 5,
          head: [columnas],
          body: filas,
          theme: "striped",
          styles: { fontSize: 8 },
          headStyles: { fillColor: [31, 59, 115], textColor: 255 },
          margin: { left: 40, right: 40 },
        });

        y = doc.lastAutoTable.finalY + 30;
        if (y > 700) {
          doc.addPage();
          y = 100;
        }
      }

      doc.setFontSize(9);
      doc.setTextColor(100);
      doc.text("Documento generado automáticamente por MedAI Smart Ward", 180, 820);

      doc.save(`${titulo.replace(/\s+/g, "_")}.pdf`);
    }

    document.getElementById("cerrar-sesion-btn")?.addEventListener("click", async () => {
      try {
        await supabase.auth.signOut();
      } catch (e) {
        console.warn("Error al cerrar sesión:", e.message);
      } finally {
        localStorage.clear();
        window.location.href = "login.html";
      }
    });
  </script>
</body>
</html>
