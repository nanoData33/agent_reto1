<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MedAI Evolution Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f2f4f5;
  --corridor: #cdd4d8;
  --card: #ffffff;
  --text: #1b1f23;
  --primary: #1d3557;
  --accent: #219ebc;
  --stable: #16a34a;
  --warning: #facc15;
  --critical: #dc2626;
  --border: #c5ccd1;
  --dark: #0f172a;
}

/* === BASE === */
body {
  margin: 0;
  font-family: "Inter", sans-serif;
  background: var(--bg);
  color: var(--text);
  overflow-x: hidden;
}

/* === HEADER === */
header {
  background: linear-gradient(90deg, var(--dark), var(--primary));
  color: white;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 14px rgba(0,0,0,0.25);
}

.brand {
  display: flex;
  align-items: center;
  gap: 0.8rem;
}
.brand img {
  width: 42px;
  height: 42px;
  filter: drop-shadow(0 0 4px rgba(255,255,255,0.3));
}
.brand h1 {
  margin: 0;
  font-size: 1.4rem;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.chat-trigger {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.45rem 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.25s;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  box-shadow: 0 3px 10px rgba(0,0,0,0.25);
}
.chat-trigger:hover { background: #0284c7; }

/* === PLANTA === */
main {
  display: flex;
  justify-content: center;
  align-items: center;
  height: calc(100vh - 90px);
  position: relative;
}
.floor {
  width: 94%;
  height: 520px;
  position: relative;
}

/* Pasillo */
.corridor {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 95%;
  height: 120px;
  background: linear-gradient(90deg, #d9dee2, #b8c0c7);
  border-radius: 45px;
  box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
  border: 4px solid var(--border);
}

/* Filas */
.rooms {
  position: absolute;
  width: 100%;
  display: flex;
  justify-content: space-evenly;
  z-index: 5;
}
.rooms.top { top: 60px; }
.rooms.bottom { bottom: 60px; }

/* Habitaciones */
.room {
  width: 145px;
  height: 95px;
  background: var(--card);
  border: 2px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  cursor: pointer;
  transition: all 0.25s ease;
  opacity: 0;
  transform: translateY(20px);
  animation: fadeIn 0.7s ease forwards;
}
@keyframes fadeIn {
  to { opacity: 1; transform: translateY(0); }
}
.room:hover {
  transform: scale(1.05);
  border-color: var(--accent);
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}
.room h3 {
  margin: 0;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--primary);
}
.status {
  margin-top: 6px;
  font-size: 0.7rem;
  padding: 0.25rem 0.6rem;
  border-radius: 6px;
  color: white;
  font-weight: 600;
}
.stable { background: var(--stable); }
.warning { background: var(--warning); color: #222; }
.critical { background: var(--critical); }

/* === POPUP PACIENTE === */
.popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: var(--card);
  width: 480px;
  border-radius: 14px;
  box-shadow: 0 15px 45px rgba(0,0,0,0.35);
  padding: 1.5rem 1.8rem;
  display: none;
  flex-direction: column;
  transition: all 0.25s ease;
  z-index: 200;
}
.popup.active {
  display: flex;
  transform: translate(-50%, -50%) scale(1);
}
.popup h2 {
  margin: 0;
  color: var(--primary);
  font-weight: 600;
}
.tabs {
  display: flex;
  gap: 0.5rem;
  margin: 1rem 0;
}
.tab {
  background: #e5ebed;
  border: none;
  border-radius: 8px;
  padding: 0.45rem 0.9rem;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.2s;
}
.tab:hover, .tab.active {
  background: var(--accent);
  color: white;
}
.content {
  background: #f7f9fa;
  border-radius: 10px;
  padding: 1rem;
  font-size: 0.85rem;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
  min-height: 130px;
  overflow-y: auto;
}
.close-btn, .ai-btn {
  border: none;
  border-radius: 8px;
  padding: 0.5rem 0.8rem;
  margin-top: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}
.ai-btn {
  background: var(--primary);
  color: white;
}
.ai-btn:hover { background: var(--accent); }
.close-btn {
  background: var(--critical);
  color: white;
  align-self: flex-end;
}
.close-btn:hover { background: #a31d1d; }

/* === CHAT MODAL === */
.chat-modal {
  position: fixed;
  right: -380px;
  top: 0;
  height: 100%;
  width: 360px;
  background: #ffffff;
  box-shadow: -4px 0 20px rgba(0,0,0,0.25);
  border-left: 4px solid var(--accent);
  transition: right 0.4s ease;
  z-index: 300;
  display: flex;
  flex-direction: column;
}
.chat-modal.active { right: 0; }

.chat-header {
  background: var(--primary);
  color: white;
  padding: 1rem;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.chat-header button {
  background: transparent;
  border: none;
  color: white;
  font-size: 1.3rem;
  cursor: pointer;
}

.chat-body {
  flex: 1;
  padding: 1rem;
  overflow-y: auto;
  font-size: 0.9rem;
  background: #f8f9fa;
  display: flex;
  flex-direction: column;
}
.chat-body p {
  background: #e9f2f4;
  padding: 0.6rem 0.8rem;
  border-radius: 8px;
  margin: 0.5rem 0;
  max-width: 80%;
}
.chat-body p.ai {
  background: #dbeef5;
  align-self: flex-start;
}
.chat-body p.user {
  background: #c8e0e8;
  align-self: flex-end;
  margin-left: auto;
}

/* === AUDIO RECORD === */
.recording {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  background: #eaf6fb;
  border-radius: 8px;
  padding: 0.3rem 0.6rem;
  color: var(--accent);
  font-weight: 500;
}
.recording span { min-width: 40px; text-align: right; }
.wave {
  display: flex;
  align-items: flex-end;
  height: 20px;
  gap: 2px;
}
.wave div {
  width: 3px;
  height: 8px;
  background: var(--accent);
  animation: waveAnim 1s infinite ease-in-out;
}
.wave div:nth-child(2) { animation-delay: 0.1s; }
.wave div:nth-child(3) { animation-delay: 0.2s; }
.wave div:nth-child(4) { animation-delay: 0.3s; }
.wave div:nth-child(5) { animation-delay: 0.4s; }
@keyframes waveAnim {
  0%, 100% { height: 8px; }
  50% { height: 18px; }
}

.chat-input {
  display: flex;
  border-top: 1px solid #ddd;
  padding: 0.6rem;
  background: white;
  align-items: center;
  gap: 0.5rem;
}
.chat-input input {
  flex: 1;
  border: none;
  outline: none;
  font-size: 0.85rem;
  padding: 0.4rem;
}
.chat-input button {
  background: var(--accent);
  border: none;
  border-radius: 8px;
  color: white;
  padding: 0.45rem 0.7rem;
  cursor: pointer;
  transition: background 0.2s;
}
.chat-input button:hover { background: #0284c7; }
.mic-btn {
  background: var(--primary);
}
.mic-btn:hover { background: #1d4ed8; }
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" alt="MedAI Logo">
    <h1>MedAI Evolution Assistant</h1>
  </div>
  <button class="chat-trigger" onclick="toggleChat()">Asistente IA</button>
</header>

<main>
  <div class="floor">
    <div class="rooms top">
      <div class="room" onclick="openPopup('Mar√≠a L√≥pez')"><h3>Hab 101</h3><div class="status warning">Pendiente</div></div>
      <div class="room" onclick="openPopup('Juan P√©rez')"><h3>Hab 102</h3><div class="status stable">Estable</div></div>
      <div class="room" onclick="openPopup('Luc√≠a Torres')"><h3>Hab 103</h3><div class="status stable">Recuperaci√≥n</div></div>
      <div class="room" onclick="openPopup('Pablo Ruiz')"><h3>Hab 104</h3><div class="status warning">En pruebas</div></div>
      <div class="room" onclick="openPopup('Sara G√≥mez')"><h3>Hab 105</h3><div class="status stable">Alta prevista</div></div>
      <div class="room" onclick="openPopup('Alba Vidal')"><h3>Hab 106</h3><div class="status stable">Estable</div></div>
    </div>

    <div class="corridor"></div>

    <div class="rooms bottom">
      <div class="room" onclick="openPopup('Pedro Ruiz')"><h3>Hab 201</h3><div class="status critical">Cr√≠tico</div></div>
      <div class="room" onclick="openPopup('Ana Gil')"><h3>Hab 202</h3><div class="status stable">Alta prevista</div></div>
      <div class="room" onclick="openPopup('Javier Mora')"><h3>Hab 203</h3><div class="status stable">Estable</div></div>
      <div class="room" onclick="openPopup('Elena Vidal')"><h3>Hab 204</h3><div class="status stable">Recuperaci√≥n</div></div>
      <div class="room" onclick="openPopup('Laura R√≠os')"><h3>Hab 205</h3><div class="status warning">Pendiente</div></div>
      <div class="room" onclick="openPopup('Beatriz Le√≥n')"><h3>Hab 206</h3><div class="status critical">Cr√≠tico</div></div>
    </div>
  </div>
</main>

<!-- POPUP PACIENTE -->
<div class="popup" id="popup">
  <h2 id="popup-name"></h2>
  <div class="tabs">
    <button class="tab active" onclick="setTab('med')">Medicaci√≥n</button>
    <button class="tab" onclick="setTab('tests')">Resultados</button>
    <button class="tab" onclick="setTab('report')">Informe</button>
  </div>
  <div class="content" id="popup-content">
    <b>Tratamiento actual:</b><br>Paracetamol 1g/8h<br>Omeprazol 20mg/d√≠a<br>Enoxaparina 40mg sc
  </div>
  <button class="ai-btn" onclick="showPrediction()">An√°lisis Predictivo IA</button>
  <button class="close-btn" onclick="closePopup()">Cerrar</button>
</div>

<!-- CHAT -->
<div class="chat-modal" id="chat">
  <div class="chat-header">
    MedAI Assistant
    <button onclick="toggleChat()">√ó</button>
  </div>
  <div class="chat-body" id="chat-body">
    <p class="ai">Hola, soy MedAI. Puedo generar res√∫menes evolutivos o analizar evoluci√≥n por voz.</p>
  </div>
  <div class="chat-input">
    <button class="mic-btn" id="mic" onclick="toggleRecording()">üéôÔ∏è</button>
    <div id="recordDisplay"></div>
    <input type="text" id="chat-input" placeholder="Escribe o graba tu consulta...">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
// === VARIABLES BASE (id√©nticas a las tuyas) ===
const popup = document.getElementById('popup');
const popupName = document.getElementById('popup-name');
const popupContent = document.getElementById('popup-content');
const chat = document.getElementById('chat');
const chatBody = document.getElementById('chat-body');
const input = document.getElementById('chat-input');
const recordDisplay = document.getElementById('recordDisplay');

let recording = false;
let timer;
let seconds = 0;

// === NUEVO: CARGAR DATOS DESDE JSON REMOTO ===
const DATA_URL = "https://raw.githubusercontent.com/tuusuario/turepo/main/pacientes_completo.json"; // ‚ö†Ô∏è cambia por tu enlace raw real
let pacientes = [];

// Carga del JSON al iniciar
window.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch(DATA_URL);
    pacientes = await res.json();
    console.log(`‚úÖ ${pacientes.length} pacientes cargados desde JSON`);
  } catch (err) {
    console.error("‚ùå Error cargando JSON:", err);
  }
});

// === CHAT ===
function toggleChat() { chat.classList.toggle('active'); }

function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  addMessage(text, "user");
  input.value = "";
  setTimeout(() => addMessage("Generando resumen evolutivo basado en los √∫ltimos datos cl√≠nicos...", "ai"), 600);
}

function addMessage(text, sender) {
  const p = document.createElement("p");
  p.textContent = text;
  p.className = sender;
  chatBody.appendChild(p);
  chatBody.scrollTop = chatBody.scrollHeight;
}

// === POPUP ===
let currentPatient = null;

function openPopup(nombre) {
  popupName.textContent = nombre;
  popup.classList.add('active');

  // Buscar paciente por nombre en JSON
  currentPatient = pacientes.find(p => (p.nombre || "").toLowerCase() === nombre.toLowerCase());
  if (currentPatient) {
    renderMedicacion();
  } else {
    popupContent.innerHTML = "<i>No se encontraron datos cl√≠nicos para este paciente.</i>";
  }
}

function closePopup() { popup.classList.remove('active'); }

function setTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');

  if (!currentPatient) {
    popupContent.innerHTML = "<i>Seleccione un paciente v√°lido.</i>";
    return;
  }

  if (tab === 'med') renderMedicacion();
  else if (tab === 'tests') renderResultados();
  else renderInforme();
}

// === RENDERIZADORES (sustituyen texto est√°tico por JSON) ===
function renderMedicacion() {
  if (currentPatient?.tratamientos?.length) {
    const html = currentPatient.tratamientos.map(t =>
      `‚Ä¢ ${t.tratamiento} (${t.via_administracion || 'v√≠a desconocida'})`
    ).join("<br>");
    popupContent.innerHTML = `<b>Tratamiento actual:</b><br>${html}`;
  } else {
    popupContent.innerHTML = "<b>Tratamiento actual:</b><br><i>No hay tratamientos registrados.</i>";
  }
}

function renderResultados() {
  if (currentPatient?.resultados_clinicos?.length) {
    const ult = currentPatient.resultados_clinicos.slice(-1)[0];
    popupContent.innerHTML = `
      <b>√öltimos resultados (${ult.fecha || "sin fecha"}):</b><br>
      Temperatura: ${ult.temperatura || "-"} ¬∞C<br>
      Frecuencia card√≠aca: ${ult.frecuencia_cardiaca || "-"} bpm<br>
      Saturaci√≥n O‚ÇÇ: ${ult.spo2 || "-"} %<br>
      PCR: ${ult.pcr_mg_l || "-"} mg/L<br>
      Estado general: ${ult.estado_general || "N/A"}
    `;
  } else {
    popupContent.innerHTML = "<b>√öltimos resultados:</b><br><i>No hay resultados disponibles.</i>";
  }
}

function renderInforme() {
  if (currentPatient?.alta_resumen?.length) {
    const ar = currentPatient.alta_resumen.slice(-1)[0];
    popupContent.innerHTML = `
      <b>Informe cl√≠nico:</b><br>
      Diagn√≥stico principal: ${ar.diagnostico_principal || "-"}<br>
      Evoluci√≥n: ${ar.evolucion_resumen || "-"}<br>
      Tratamiento al alta: ${ar.tratamiento_alta || "-"}<br>
      Seguimiento: ${ar.seguimiento_recomendado || "-"}<br>
      <br><button class='ai-btn' onclick='alert("Informe descargado para ${currentPatient.nombre}.")'>Descargar PDF</button>
    `;
  } else {
    popupContent.innerHTML = "<b>Informe cl√≠nico:</b><br><i>No hay informe disponible.</i>";
  }
}

// === IA ===
function showPrediction() {
  popupContent.innerHTML = `
    <b>Predicci√≥n IA:</b><br>
    Alta estimada en ${(Math.random() * 3 + 1).toFixed(1)} d√≠as.<br>
    Probabilidad de evoluci√≥n favorable: <b>${(Math.random() * 15 + 80).toFixed(1)}%</b>.<br><br>
    Recomendaci√≥n: continuar fisioterapia y control diario.
  `;
}

// === AUDIO RECORDING (id√©ntico al tuyo) ===
function toggleRecording() { recording ? stopRecording() : startRecording(); }

function startRecording() {
  recording = true;
  seconds = 0;
  recordDisplay.innerHTML = `
    <div class="recording">
      <div class="wave">${"<div></div>".repeat(5)}</div>
      <span id="timer">0:00</span>
    </div>`;
  timer = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = String(seconds % 60).padStart(2, "0");
    document.getElementById("timer").textContent = `${mins}:${secs}`;
  }, 1000);
}

function stopRecording() {
  recording = false;
  clearInterval(timer);
  recordDisplay.innerHTML = "";
  addMessage("Audio registrado (duraci√≥n " + seconds + "s). Transcribiendo...", "user");
  setTimeout(() => addMessage("An√°lisis de voz completado. Evoluci√≥n estable sin signos de empeoramiento.", "ai"), 800);
}
</script>

</body>
</html>
