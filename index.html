<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MedAI Evolution Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* --- tu CSS original, sin tocar --- */
:root {
  --bg: #f2f4f5;
  --corridor: #cdd4d8;
  --card: #ffffff;
  --text: #1b1f23;
  --primary: #1d3557;
  --accent: #219ebc;
  --stable: #16a34a;
  --warning: #facc15;
  --critical: #dc2626;
  --border: #c5ccd1;
  --dark: #0f172a;
}
body { margin: 0; font-family: "Inter", sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
/* --- resto del CSS igual que el tuyo --- */
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" alt="MedAI Logo">
    <h1>MedAI Evolution Assistant</h1>
  </div>
  <button class="chat-trigger" onclick="toggleChat()">Asistente IA</button>
</header>

<main>
  <div class="floor">
    <div class="rooms top">
      <div class="room" onclick="openPopup('Mar√≠a L√≥pez')"><h3>Hab 101</h3><div class="status warning">Pendiente</div></div>
      <div class="room" onclick="openPopup('Juan P√©rez')"><h3>Hab 102</h3><div class="status stable">Estable</div></div>
      <div class="room" onclick="openPopup('Luc√≠a Torres')"><h3>Hab 103</h3><div class="status stable">Recuperaci√≥n</div></div>
      <div class="room" onclick="openPopup('Pablo Ruiz')"><h3>Hab 104</h3><div class="status warning">En pruebas</div></div>
      <div class="room" onclick="openPopup('Sara G√≥mez')"><h3>Hab 105</h3><div class="status stable">Alta prevista</div></div>
      <div class="room" onclick="openPopup('Alba Vidal')"><h3>Hab 106</h3><div class="status stable">Estable</div></div>
    </div>
    <div class="corridor"></div>
    <div class="rooms bottom">
      <div class="room" onclick="openPopup('Pedro Ruiz')"><h3>Hab 201</h3><div class="status critical">Cr√≠tico</div></div>
      <div class="room" onclick="openPopup('Ana Gil')"><h3>Hab 202</h3><div class="status stable">Alta prevista</div></div>
      <div class="room" onclick="openPopup('Javier Mora')"><h3>Hab 203</h3><div class="status stable">Estable</div></div>
      <div class="room" onclick="openPopup('Elena Vidal')"><h3>Hab 204</h3><div class="status stable">Recuperaci√≥n</div></div>
      <div class="room" onclick="openPopup('Laura R√≠os')"><h3>Hab 205</h3><div class="status warning">Pendiente</div></div>
      <div class="room" onclick="openPopup('Beatriz Le√≥n')"><h3>Hab 206</h3><div class="status critical">Cr√≠tico</div></div>
    </div>
  </div>
</main>

<!-- POPUP -->
<div class="popup" id="popup">
  <h2 id="popup-name"></h2>
  <div class="tabs">
    <button class="tab active" onclick="setTab('med')">Medicaci√≥n</button>
    <button class="tab" onclick="setTab('tests')">Resultados</button>
    <button class="tab" onclick="setTab('report')">Informe</button>
  </div>
  <div class="content" id="popup-content"><i>Cargando...</i></div>
  <button class="ai-btn" onclick="showPrediction()">An√°lisis Predictivo IA</button>
  <button class="close-btn" onclick="closePopup()">Cerrar</button>
</div>

<!-- CHAT -->
<div class="chat-modal" id="chat">
  <div class="chat-header">MedAI Assistant<button onclick="toggleChat()">√ó</button></div>
  <div class="chat-body" id="chat-body">
    <p class="ai">Hola, soy MedAI. Puedo generar res√∫menes evolutivos o analizar evoluci√≥n por voz.</p>
  </div>
  <div class="chat-input">
    <button class="mic-btn" id="mic" onclick="toggleRecording()">üéôÔ∏è</button>
    <div id="recordDisplay"></div>
    <input type="text" id="chat-input" placeholder="Escribe o graba tu consulta...">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
/* === CARGAR JSON DESDE GITHUB === */
const DATA_URL = "https://raw.githubusercontent.com/nanoData33/agent_reto1/refs/heads/main/pacientes_completo.json"; // <--- cambia esto
let pacientes = [];
let currentPatient = null;

window.addEventListener("DOMContentLoaded", async () => {
  try {
    const res = await fetch(DATA_URL);
    pacientes = await res.json();
    console.log(`‚úÖ ${pacientes.length} pacientes cargados.`);
  } catch (e) {
    console.error("‚ùå Error al cargar JSON:", e);
  }
});

/* === POPUP === */
function openPopup(nombre) {
  const popup = document.getElementById('popup');
  const popupName = document.getElementById('popup-name');
  const popupContent = document.getElementById('popup-content');

  popupName.textContent = nombre;
  popup.classList.add('active');

  currentPatient = pacientes.find(p => (p.nombre || "").toLowerCase() === nombre.toLowerCase());
  if (currentPatient) renderMedicacion();
  else popupContent.innerHTML = "<i>No se encontraron datos cl√≠nicos para este paciente.</i>";
}

function closePopup() {
  document.getElementById('popup').classList.remove('active');
}

function setTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');

  if (!currentPatient) return;

  if (tab === 'med') renderMedicacion();
  else if (tab === 'tests') renderResultados();
  else renderInforme();
}

/* === RENDER === */
function renderMedicacion() {
  const c = document.getElementById('popup-content');
  if (currentPatient?.tratamientos?.length) {
    const html = currentPatient.tratamientos.map(t => `‚Ä¢ ${t.tratamiento} (${t.via_administracion || 'v√≠a desconocida'})`).join("<br>");
    c.innerHTML = `<b>Tratamiento actual:</b><br>${html}`;
  } else c.innerHTML = "<i>No hay tratamientos registrados.</i>";
}

function renderResultados() {
  const c = document.getElementById('popup-content');
  if (currentPatient?.resultados_clinicos?.length) {
    const ult = currentPatient.resultados_clinicos.slice(-1)[0];
    c.innerHTML = `
      <b>√öltimos resultados (${ult.fecha || "sin fecha"}):</b><br>
      Temperatura: ${ult.temperatura || "-"} ¬∞C<br>
      Frecuencia card√≠aca: ${ult.frecuencia_cardiaca || "-"} bpm<br>
      Saturaci√≥n O‚ÇÇ: ${ult.spo2 || "-"} %<br>
      PCR: ${ult.pcr_mg_l || "-"} mg/L<br>
      Estado general: ${ult.estado_general || "N/A"}
    `;
  } else c.innerHTML = "<i>No hay resultados disponibles.</i>";
}

function renderInforme() {
  const c = document.getElementById('popup-content');
  if (currentPatient?.alta_resumen?.length) {
    const ar = currentPatient.alta_resumen.slice(-1)[0];
    c.innerHTML = `
      <b>Informe cl√≠nico:</b><br>
      Diagn√≥stico principal: ${ar.diagnostico_principal || "-"}<br>
      Evoluci√≥n: ${ar.evolucion_resumen || "-"}<br>
      Tratamiento al alta: ${ar.tratamiento_alta || "-"}<br>
      Seguimiento: ${ar.seguimiento_recomendado || "-"}<br><br>
      <button class='ai-btn' onclick='alert("Informe descargado para ${currentPatient.nombre}.")'>Descargar PDF</button>
    `;
  } else c.innerHTML = "<i>No hay informe disponible.</i>";
}

/* === PREDICCI√ìN === */
function showPrediction() {
  const c = document.getElementById('popup-content');
  c.innerHTML = `
    <b>Predicci√≥n IA:</b><br>
    Alta estimada en ${(Math.random() * 3 + 1).toFixed(1)} d√≠as.<br>
    Probabilidad de evoluci√≥n favorable: <b>${(Math.random() * 15 + 80).toFixed(1)}%</b>.<br><br>
    Recomendaci√≥n: continuar fisioterapia y control diario.
  `;
}

/* === CHAT === */
function toggleChat() { document.getElementById('chat').classList.toggle('active'); }
function sendMessage() {
  const text = document.getElementById('chat-input').value.trim();
  if (!text) return;
  addMessage(text, "user");
  document.getElementById('chat-input').value = "";
  setTimeout(() => addMessage("Generando resumen evolutivo basado en los √∫ltimos datos cl√≠nicos...", "ai"), 600);
}
function addMessage(text, sender) {
  const p = document.createElement("p");
  p.textContent = text;
  p.className = sender;
  const chatBody = document.getElementById('chat-body');
  chatBody.appendChild(p);
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* === AUDIO === */
let recording = false, timer, seconds = 0;
function toggleRecording() { recording ? stopRecording() : startRecording(); }
function startRecording() {
  recording = true; seconds = 0;
  const r = document.getElementById('recordDisplay');
  r.innerHTML = `
    <div class="recording">
      <div class="wave">${"<div></div>".repeat(5)}</div>
      <span id="timer">0:00</span>
    </div>`;
  timer = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = String(seconds % 60).padStart(2, "0");
    document.getElementById("timer").textContent = `${mins}:${secs}`;
  }, 1000);
}
function stopRecording() {
  recording = false;
  clearInterval(timer);
  document.getElementById('recordDisplay').innerHTML = "";
  addMessage("Audio registrado (duraci√≥n " + seconds + "s). Transcribiendo...", "user");
  setTimeout(() => addMessage("An√°lisis de voz completado. Evoluci√≥n estable sin signos de empeoramiento.", "ai"), 800);
}
</script>

</body>
</html>
