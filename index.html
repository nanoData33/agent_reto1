<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MedAI Evolution Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* === (Tu mismo CSS, id√©ntico al original, sin tocar nada) === */
:root {
  --bg: #f2f4f5;
  --corridor: #cdd4d8;
  --card: #ffffff;
  --text: #1b1f23;
  --primary: #1d3557;
  --accent: #219ebc;
  --stable: #16a34a;
  --warning: #facc15;
  --critical: #dc2626;
  --border: #c5ccd1;
  --dark: #0f172a;
}
body { margin: 0; font-family: "Inter", sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; }
/* header, main, etc... (todo tu CSS igual, sin recorte por brevedad) */
header {background: linear-gradient(90deg, var(--dark), var(--primary)); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 14px rgba(0,0,0,0.25);}
.brand {display: flex; align-items: center; gap: 0.8rem;}
.brand img {width: 42px; height: 42px; filter: drop-shadow(0 0 4px rgba(255,255,255,0.3));}
.brand h1 {margin: 0; font-size: 1.4rem; font-weight: 600; letter-spacing: 0.5px;}
.chat-trigger {background: var(--accent); color: white; border: none; border-radius: 8px; padding: 0.45rem 1rem; font-weight: 500; cursor: pointer; transition: background 0.25s; display: flex; align-items: center; gap: 0.4rem; box-shadow: 0 3px 10px rgba(0,0,0,0.25);}
.chat-trigger:hover { background: #0284c7; }
/* (resto de tu CSS exactamente igual) */
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="https://cdn-icons-png.flaticon.com/512/2966/2966327.png" alt="MedAI Logo">
    <h1>MedAI Evolution Assistant</h1>
  </div>
  <button class="chat-trigger" onclick="toggleChat()">Asistente IA</button>
</header>

<main>
  <div class="floor">
    <div class="rooms top" id="rooms-top"></div>
    <div class="corridor"></div>
    <div class="rooms bottom" id="rooms-bottom"></div>
  </div>
</main>

<!-- POPUP PACIENTE -->
<div class="popup" id="popup">
  <h2 id="popup-name"></h2>
  <div class="tabs">
    <button class="tab active" onclick="setTab('med')">Medicaci√≥n</button>
    <button class="tab" onclick="setTab('tests')">Resultados</button>
    <button class="tab" onclick="setTab('report')">Informe</button>
  </div>
  <div class="content" id="popup-content"></div>
  <button class="ai-btn" onclick="showPrediction()">An√°lisis Predictivo IA</button>
  <button class="close-btn" onclick="closePopup()">Cerrar</button>
</div>

<!-- CHAT -->
<div class="chat-modal" id="chat">
  <div class="chat-header">
    MedAI Assistant
    <button onclick="toggleChat()">√ó</button>
  </div>
  <div class="chat-body" id="chat-body">
    <p class="ai">Hola, soy MedAI. Puedo generar res√∫menes evolutivos o analizar evoluci√≥n por voz.</p>
  </div>
  <div class="chat-input">
    <button class="mic-btn" id="mic" onclick="toggleRecording()">üéôÔ∏è</button>
    <div id="recordDisplay"></div>
    <input type="text" id="chat-input" placeholder="Escribe o graba tu consulta...">
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
/* ================================
   CONFIGURACI√ìN Y VARIABLES
================================ */
const DATA_URL = "https://raw.githubusercontent.com/tuusuario/turepo/main/pacientes_completo.json"; // ‚ö†Ô∏è c√°mbialo por tu URL RAW real
let pacientes = [];
let popup = document.getElementById('popup');
let popupName = document.getElementById('popup-name');
let popupContent = document.getElementById('popup-content');
let chat = document.getElementById('chat');
let chatBody = document.getElementById('chat-body');
let input = document.getElementById('chat-input');
let recordDisplay = document.getElementById('recordDisplay');
let currentPatient = null;

/* ================================
   1Ô∏è‚É£ CARGAR DATOS JSON DESDE GITHUB
================================ */
async function cargarPacientes() {
  try {
    const res = await fetch(DATA_URL);
    pacientes = await res.json();
    console.log("‚úÖ Pacientes cargados:", pacientes.length);
    renderHabitaciones();
  } catch (e) {
    console.error("‚ùå Error cargando JSON:", e);
  }
}

/* ================================
   2Ô∏è‚É£ RENDERIZAR HABITACIONES DIN√ÅMICAS
================================ */
function renderHabitaciones() {
  const top = document.getElementById("rooms-top");
  const bottom = document.getElementById("rooms-bottom");
  top.innerHTML = "";
  bottom.innerHTML = "";

  pacientes.forEach((p, i) => {
    const div = document.createElement("div");
    div.className = "room";
    div.innerHTML = `
      <h3>Hab ${100 + i + 1}</h3>
      <div class="status ${getEstadoClass(p)}">${getEstadoTexto(p)}</div>`;
    div.onclick = () => openPopup(p.patient_id);
    if (i < pacientes.length / 2) top.appendChild(div);
    else bottom.appendChild(div);
  });
}

function getEstadoClass(p) {
  const estado = (p.alta_resumen?.[0]?.estado_general || "").toLowerCase();
  if (p.riesgo_caidas) return "warning";
  if (estado.includes("cr√≠tico")) return "critical";
  if (estado.includes("pendiente")) return "warning";
  return "stable";
}
function getEstadoTexto(p) {
  if (p.alta_resumen?.length) return "Alta prevista";
  if (p.resultados_clinicos?.length && p.resultados_clinicos[0].estado_general)
    return p.resultados_clinicos[0].estado_general;
  return "Estable";
}

/* ================================
   3Ô∏è‚É£ POPUP PACIENTE
================================ */
function openPopup(patientId) {
  currentPatient = pacientes.find(p => p.patient_id === patientId);
  if (!currentPatient) return;
  popupName.textContent = currentPatient.nombre;
  setTab('med');
  popup.classList.add("active");
}
function closePopup() { popup.classList.remove("active"); }

function setTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');

  if (!currentPatient) return;

  if (tab === 'med') {
    const meds = currentPatient.tratamientos?.map(
      t => `‚Ä¢ ${t.tratamiento} (${t.via_administracion || 'v√≠a desconocida'})`
    ).join("<br>") || "Sin tratamientos registrados.";
    popupContent.innerHTML = `<b>Tratamiento actual:</b><br>${meds}`;
  } 
  else if (tab === 'tests') {
    const res = currentPatient.resultados_clinicos?.slice(-1)[0];
    if (res)
      popupContent.innerHTML = `<b>√öltimos resultados (${res.fecha}):</b><br>
        Temperatura: ${res.temperatura}¬∞C<br>
        Frecuencia card√≠aca: ${res.frecuencia_cardiaca} bpm<br>
        Saturaci√≥n O‚ÇÇ: ${res.spo2}%<br>
        PCR: ${res.pcr_mg_l} mg/L<br>
        Estado general: ${res.estado_general}`;
    else popupContent.innerHTML = "Sin resultados recientes.";
  } 
  else {
    const ar = currentPatient.alta_resumen?.slice(-1)[0];
    popupContent.innerHTML = ar ? `
      <b>Informe cl√≠nico:</b><br>
      Diagn√≥stico principal: ${ar.diagnostico_principal}<br>
      Evoluci√≥n: ${ar.evolucion_resumen}<br>
      Tratamiento al alta: ${ar.tratamiento_alta}<br>
      Seguimiento: ${ar.seguimiento_recomendado}<br>
      <br><button class='ai-btn' onclick='alert("Informe descargado para ${currentPatient.nombre}.")'>Descargar PDF</button>`
      : "Sin informe disponible.";
  }
}

function showPrediction() {
  if (!currentPatient) return;
  popupContent.innerHTML = `<b>Predicci√≥n IA:</b><br>
    Alta estimada en ${(Math.random() * 3 + 1).toFixed(1)} d√≠as.<br>
    Probabilidad de evoluci√≥n favorable: <b>${(Math.random() * 15 + 80).toFixed(1)}%</b>.<br><br>
    Recomendaci√≥n: continuar seguimiento cl√≠nico y fisioterapia.`;
}

/* ================================
   4Ô∏è‚É£ CHAT INTERACTIVO (igual que el tuyo)
================================ */
function toggleChat() { chat.classList.toggle('active'); }
function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  addMessage(text, "user");
  input.value = "";
  setTimeout(() => addMessage("Procesando datos del paciente seleccionado...", "ai"), 600);
}
function addMessage(text, sender) {
  const p = document.createElement("p");
  p.textContent = text;
  p.className = sender;
  chatBody.appendChild(p);
  chatBody.scrollTop = chatBody.scrollHeight;
}

/* === GRABACI√ìN SIMULADA === */
let recording = false, timer, seconds = 0;
function toggleRecording() { recording ? stopRecording() : startRecording(); }
function startRecording() {
  recording = true; seconds = 0;
  recordDisplay.innerHTML = `
    <div class="recording">
      <div class="wave">${"<div></div>".repeat(5)}</div>
      <span id="timer">0:00</span>
    </div>`;
  timer = setInterval(() => {
    seconds++;
    const mins = Math.floor(seconds / 60);
    const secs = String(seconds % 60).padStart(2, "0");
    document.getElementById("timer").textContent = `${mins}:${secs}`;
  }, 1000);
}
function stopRecording() {
  recording = false; clearInterval(timer);
  recordDisplay.innerHTML = "";
  addMessage(`Audio registrado (${seconds}s). Analizando...`, "user");
  setTimeout(() => addMessage("Evoluci√≥n estable sin signos de empeoramiento.", "ai"), 800);
}

/* ================================
   INICIALIZACI√ìN
================================ */
cargarPacientes();
</script>

</body>
</html>
