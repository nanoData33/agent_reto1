<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Actividad cl√≠nica | MedAI Evolution Ward</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter',sans-serif; background:#f8fafc; margin:0; color:#1f1f1f; }
    header { background:#004aad; color:white; padding:15px 40px; display:flex; justify-content:space-between; align-items:center; }
    .container { width:90%; margin:40px auto; display:flex; flex-direction:column; gap:40px; }
    canvas { background:white; border-radius:14px; box-shadow:0 4px 16px rgba(0,0,0,0.1); padding:20px; }
    button { border:none; border-radius:6px; font-weight:600; cursor:pointer; background:white; color:#004aad; padding:6px 14px; transition:0.3s; }
    button:hover { background:#dce9ff; transform:scale(1.05); }
    h2 { margin:0; }
  </style>
</head>
<body>
  <header>
    <h2>üìà Actividad cl√≠nica</h2>
    <button onclick="window.location='index.html'">‚Üê Volver</button>
  </header>

  <div class="container">
    <canvas id="grafEvol"></canvas>
    <canvas id="grafNotas"></canvas>
    <canvas id="grafServicios"></canvas>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://aczjgeleupwlvghjhkav.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjempnZWxldXB3bHZnaGpoa2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzgwODMsImV4cCI6MjA3NjU1NDA4M30.-hQdLNDMw-i4vCpt_OXnzYss5MtVrCu76FhMCPcZPhM"
    );

    async function cargarActividad() {
      const { data: evol, error: e1 } = await supabase.from("evolucion").select("Fecha,PacienteID");
      const { data: notas, error: e2 } = await supabase.from("notas").select("Fecha,PacienteID");
      const { data: pacientes, error: e3 } = await supabase.from("pacientes").select("PacienteID,Servicio");

      if (e1 || e2 || e3) return console.error(e1||e2||e3);

      // N¬∫ de registros de evoluci√≥n por d√≠a
      const evolCount = contarPorDia(evol);
      const notaCount = contarPorDia(notas);

      // Registros por servicio
      const evolPorServicio = pacientes.reduce((acc,p)=>{
        const count = evol.filter(ev=>ev.PacienteID===p.PacienteID).length;
        acc[p.Servicio] = (acc[p.Servicio]||0) + count;
        return acc;
      },{});

      renderChart("grafEvol","Evoluciones registradas por d√≠a",Object.keys(evolCount),Object.values(evolCount),"#004aad");
      renderChart("grafNotas","Notas m√©dicas por d√≠a",Object.keys(notaCount),Object.values(notaCount),"#2ecc71");
      renderChart("grafServicios","Evoluciones por servicio",Object.keys(evolPorServicio),Object.values(evolPorServicio),"#f39c12");
    }

    function contarPorDia(arr) {
      const counts={};
      arr.forEach(d=>{
        if(!d.Fecha) return;
        const f=new Date(d.Fecha).toISOString().slice(0,10);
        counts[f]=(counts[f]||0)+1;
      });
      return counts;
    }

    function renderChart(id,titulo,labels,values,color){
      new Chart(document.getElementById(id),{
        type:"bar",
        data:{labels,datasets:[{label:titulo,data:values,backgroundColor:color}]},
        options:{
          plugins:{title:{display:true,text:titulo,color:"#004aad",font:{size:16,weight:"600"}}},
          scales:{x:{ticks:{color:"#444"}},y:{beginAtZero:true}}
        }
      });
    }

    cargarActividad();
  </script>
</body>
</html>
