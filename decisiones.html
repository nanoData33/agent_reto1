<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Decisiones AI — MedAI Evolution Ward</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body { font-family: "Inter", sans-serif; background: #f6f8fb; color: #2d2d2d; margin: 0; }
    header {
      background: #fff; box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      padding: 14px 40px; display: flex; justify-content: space-between; align-items: center;
    }
    header span { font-weight: 700; font-size: 1.3rem; color: #1f3b73; display: flex; align-items: center; gap: 10px; }
    .columns { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; padding: 30px; }
    .col {
      flex: 1; min-width: 420px; background: #fff; border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08); padding: 20px;
    }
    .col h2 { font-size: 1.2rem; color: #1f3b73; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .card {
      background: #f9fbff; border-radius: 10px; padding: 16px; margin-bottom: 12px;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.05);
    }
    .card strong { color: #1f3b73; }
    .reason { font-size: 0.85rem; color: #666; margin-top: 6px; line-height: 1.4; }
    .stats { font-size: 0.8rem; color: #333; margin-top: 8px; background: #eef3ff; border-radius: 8px; padding: 6px 8px; }
    button {
      background: #1f3b73; color: white; border: none; border-radius: 8px;
      padding: 6px 12px; font-weight: 600; cursor: pointer; margin-top: 10px;
    }
    button:hover { background: #3a6ff8; }
  </style>
</head>

<body>
  <header>
    <span><i class="fa-solid fa-user-md"></i> Decisiones AI</span>
    <button onclick="window.location='index.html'"><i class="fa-solid fa-arrow-left"></i> Volver</button>
  </header>

  <div class="columns">
    <div class="col" id="altas">
      <h2><i class="fa-solid fa-bed"></i> Sugerencias de alta</h2>
      <p id="noAltas">Cargando datos...</p>
    </div>
    <div class="col" id="ingresos">
      <h2><i class="fa-solid fa-user-plus"></i> Sugerencias de ingreso</h2>
      <p id="noIngresos">Cargando datos...</p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://aczjgeleupwlvghjhkav.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjempnZWxldXB3bHZnaGpoa2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzgwODMsImV4cCI6MjA3NjU1NDA4M30.-hQdLNDMw-i4vCpt_OXnzYss5MtVrCu76FhMCPcZPhM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    async function loadDecisiones() {
      const { data: pacientes, error } = await supabase.from("pacientes").select("*");
      if (error) { console.error(error); return; }

      const { data: evol } = await supabase.from("evolucion").select("*");
      const { data: signos } = await supabase.from("signos_vitales").select("*");
      const { data: labs } = await supabase.from("lab_iniciales").select("*");

      const altasDiv = document.getElementById("altas");
      const ingresosDiv = document.getElementById("ingresos");
      document.getElementById("noAltas").remove();
      document.getElementById("noIngresos").remove();

      let altas = 0, ingresos = 0;

      pacientes.forEach(p => {
        const evoluciones = evol.filter(e => e.PacienteID === p.PacienteID);
        const signosRecientes = signos.filter(s => s.PacienteID === p.PacienteID);
        const labsRecientes = labs.filter(l => l.PacienteID === p.PacienteID);

        // Buscar valores recientes
        const ultSignos = signosRecientes.at(-1) || {};
        const ultLab = labsRecientes.at(-1) || {};

        const hr = ultSignos.FrecuenciaCardiaca;
        const temp = ultSignos.Temperatura;
        const sat = ultSignos.SaturacionOxigeno;
        const hb = ultLab.Hemoglobina;
        const leu = ultLab.Leucocitos;
        const crea = ultLab.Creatinina;

        let motivos = [];
        let tipo = null;

        // --- Reglas para alta médica ---
        if (p.FechaIngreso && hr && temp && sat) {
          if (hr >= 60 && hr <= 100 && temp < 37.5 && sat >= 95) {
            tipo = "alta";
            motivos.push("Signos vitales estables y dentro del rango normal.");
            if (hb && hb >= 11) motivos.push("Hemoglobina adecuada.");
            if (leu && leu < 10000) motivos.push("No hay signos de infección.");
          }
        }

        // --- Reglas para ingreso sugerido ---
        if (!p.FechaIngreso || !tipo) {
          let alterado = false;
          if (hb && hb < 10) { motivos.push("Hemoglobina baja (" + hb + " g/dL)"); alterado = true; }
          if (leu && leu > 12000) { motivos.push("Leucocitos elevados (" + leu + "/µL)"); alterado = true; }
          if (crea && crea > 1.5) { motivos.push("Creatinina elevada (" + crea + " mg/dL)"); alterado = true; }
          if (temp && temp > 38) { motivos.push("Fiebre (" + temp + " °C)"); alterado = true; }
          if (alterado) tipo = "ingreso";
        }

        if (tipo === "alta") {
          altas++;
          altasDiv.innerHTML += `
            <div class="card">
              <strong>${p.Nombre}</strong> (${p.Edad} años, ${p.Sexo})<br>
              Diagnóstico: ${p.DiagnosticoPrincipal || "No especificado"}<br>
              <div class="reason">${motivos.join(" ")}<br><b>Recomendación:</b> Evaluar alta médica supervisada.</div>
              <div class="stats">
                FC: ${hr || "-"} bpm | Temp: ${temp || "-"} °C | SatO₂: ${sat || "-"}% | Hb: ${hb || "-"} | Leu: ${leu || "-"} | Crea: ${crea || "-"}
              </div>
              <button onclick="verDetalles('${p.PacienteID}')">Ver detalles</button>
            </div>`;
        }

        if (tipo === "ingreso") {
          ingresos++;
          ingresosDiv.innerHTML += `
            <div class="card">
              <strong>${p.Nombre}</strong> (${p.Edad} años, ${p.Sexo})<br>
              Motivo: ${p.MotivoIngreso || "No registrado"}<br>
              <div class="reason">${motivos.join(" ")}<br><b>Recomendación:</b> Evaluar ingreso hospitalario.</div>
              <div class="stats">
                Hb: ${hb || "-"} | Leu: ${leu || "-"} | Crea: ${crea || "-"} | Temp: ${temp || "-"} °C | SatO₂: ${sat || "-"}%
              </div>
              <button onclick="verDetalles('${p.PacienteID}')">Ver detalles</button>
            </div>`;
        }
      });

      if (altas === 0) altasDiv.innerHTML += `<p>No hay pacientes listos para el alta.</p>`;
      if (ingresos === 0) ingresosDiv.innerHTML += `<p>No hay pacientes pendientes de ingreso.</p>`;
    }

    function verDetalles(id) {
      window.open(`paciente.html?id=${id}`, "_blank");
    }

    loadDecisiones();
  </script>
</body>
</html>
