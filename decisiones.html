<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Decisiones AI ‚Äî MedAI Evolution Ward</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body { font-family: "Inter", sans-serif; background: #f6f8fb; color: #2d2d2d; margin: 0; }
    header {
      background: #fff; box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      padding: 14px 40px; display: flex; justify-content: space-between; align-items: center;
    }
    header span { font-weight: 700; font-size: 1.3rem; color: #1f3b73; display: flex; align-items: center; gap: 10px; }
    .columns { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; padding: 30px; }
    .col {
      flex: 1; min-width: 420px; background: #fff; border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08); padding: 20px;
    }
    .col h2 { font-size: 1.2rem; color: #1f3b73; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .card {
      background: #f9fbff; border-radius: 10px; padding: 16px; margin-bottom: 12px;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.05);
    }
    .card strong { color: #1f3b73; }
    .reason { font-size: 0.85rem; color: #555; margin-top: 6px; line-height: 1.4; }
    .stats { font-size: 0.8rem; color: #333; margin-top: 8px; background: #eef3ff; border-radius: 8px; padding: 6px 8px; }
    button {
      background: #1f3b73; color: white; border: none; border-radius: 8px;
      padding: 6px 12px; font-weight: 600; cursor: pointer; margin-top: 10px;
    }
    button:hover { background: #3a6ff8; }
  </style>
</head>

<body>
  <header>
    <span><i class="fa-solid fa-user-md"></i> Decisiones AI</span>
    <button onclick="window.location='index.html'"><i class="fa-solid fa-arrow-left"></i> Volver</button>
  </header>

  <div class="columns">
    <div class="col" id="altas">
      <h2><i class="fa-solid fa-bed"></i> Sugerencias de alta</h2>
      <p id="noAltas">Cargando datos...</p>
    </div>
    <div class="col" id="ingresos">
      <h2><i class="fa-solid fa-user-plus"></i> Sugerencias de ingreso</h2>
      <p id="noIngresos">Cargando datos...</p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://aczjgeleupwlvghjhkav.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjempnZWxldXB3bHZnaGpoa2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzgwODMsImV4cCI6MjA3NjU1NDA4M30.-hQdLNDMw-i4vCpt_OXnzYss5MtVrCu76FhMCPcZPhM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let ocupadas = JSON.parse(localStorage.getItem('habitaciones_ocupadas')) || [];

    async function loadDecisiones() {
      const { data: pacientes } = await supabase.from("vista_pacientes_dashboard_chat").select("*");
      if (!pacientes) return;

      const altasDiv = document.getElementById("altas");
      const ingresosDiv = document.getElementById("ingresos");
      document.getElementById("noAltas")?.remove();
      document.getElementById("noIngresos")?.remove();

      let altas = 0, ingresos = 0;
      altasDiv.innerHTML = `<h2><i class="fa-solid fa-bed"></i> Sugerencias de alta</h2>`;
      ingresosDiv.innerHTML = `<h2><i class="fa-solid fa-user-plus"></i> Sugerencias de ingreso</h2>`;

      pacientes.forEach(p => {
        const idNum = parseInt(p.PacienteID.replace(/\D/g, "")) || 0;
        let score = p.trend_score;

        // Simular score si no existe
        if (score === null || score === undefined) {
          if (idNum >= 12) score = Math.random() * 0.6; // m√°s probabilidad de ingreso
          else score = 0.4 + Math.random() * 0.6;
        }

        // Si est√° ingresado
        const enPlanta = ocupadas.includes(p.PacienteID) || idNum <= 11;
        let motivos = [], tipo = null;

        if (enPlanta && score > 0.75) {
          tipo = "alta";
          motivos.push("Tendencia cl√≠nica estable. Evoluci√≥n favorable.");
        }
        if (!enPlanta && score < 0.45) {
          tipo = "ingreso";
          motivos.push("Empeoramiento o tendencia negativa detectada.");
        }

        // Mostrar tarjetas
        if (tipo === "alta") {
          altas++;
          altasDiv.innerHTML += `
            <div class="card" id="card-${p.PacienteID}">
              <strong>${p.Nombre}</strong> (${p.Edad} a√±os, ${p.Sexo})<br>
              Diagn√≥stico: ${p.DiagnosticoPrincipal || "No especificado"}<br>
              <div class="reason">${motivos.join(" ")}<br><b>Score:</b> ${(score*100).toFixed(1)}%</div>
              <button onclick="darAlta('${p.PacienteID}')">Dar alta</button>
            </div>`;
        }
        if (tipo === "ingreso") {
          ingresos++;
          ingresosDiv.innerHTML += `
            <div class="card" id="card-${p.PacienteID}">
              <strong>${p.Nombre}</strong> (${p.Edad} a√±os, ${p.Sexo})<br>
              Motivo: ${p.MotivoIngreso || "No registrado"}<br>
              <div class="reason">${motivos.join(" ")}<br><b>Score:</b> ${(score*100).toFixed(1)}%</div>
              <button onclick="ingresar('${p.PacienteID}')">Ingresar</button>
            </div>`;
        }
      });

      if (altas === 0) altasDiv.innerHTML += `<p>No hay pacientes listos para el alta.</p>`;
      if (ingresos === 0) ingresosDiv.innerHTML += `<p>No hay pacientes pendientes de ingreso.</p>`;
    }

    function darAlta(id) {
      ocupadas = ocupadas.filter(p => p !== id);
      localStorage.setItem('habitaciones_ocupadas', JSON.stringify(ocupadas));
      document.getElementById(`card-${id}`).remove();
      alert(`üè• Paciente ${id} dado de alta. Habitaci√≥n liberada.`);
    }

    function ingresar(id) {
      if (ocupadas.length >= 12) {
        alert("‚ö†Ô∏è No hay habitaciones disponibles.");
        return;
      }
      ocupadas.push(id);
      localStorage.setItem('habitaciones_ocupadas', JSON.stringify(ocupadas));
      document.getElementById(`card-${id}`).remove();
      alert(`ü©∫ Paciente ${id} ingresado correctamente.`);
    }

    loadDecisiones();
  </script>
</body>
</html>
