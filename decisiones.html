<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Decisiones AI ‚Äî MedAI Evolution Ward</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { font-family: "Inter", sans-serif; background: #f6f8fb; color: #2d2d2d; margin: 0; }
    header {
      background: #fff; box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      padding: 14px 40px; display: flex; justify-content: space-between; align-items: center;
    }
    header span { font-weight: 700; font-size: 1.3rem; color: #1f3b73; display: flex; align-items: center; gap: 10px; }
    .columns { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; padding: 30px; }
    .col {
      flex: 1; min-width: 420px; background: #fff; border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08); padding: 20px;
    }
    .col h2 { font-size: 1.2rem; color: #1f3b73; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .card {
      background: #f9fbff; border-radius: 10px; padding: 16px; margin-bottom: 12px;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.05);
    }
    .card strong { color: #1f3b73; }
    .reason { font-size: 0.85rem; color: #555; margin-top: 6px; line-height: 1.4; }
    .stats { font-size: 0.8rem; color: #333; margin-top: 8px; background: #eef3ff; border-radius: 8px; padding: 6px 8px; }
    button {
      background: #1f3b73; color: white; border: none; border-radius: 8px;
      padding: 6px 12px; font-weight: 600; cursor: pointer; margin-top: 10px;
      transition: all .2s;
    }
    button:hover { background: #3a6ff8; transform: translateY(-2px); }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
  </style>
</head>

<body>
  <header>
    <span><i class="fa-solid fa-user-md"></i> Decisiones AI</span>
    <button onclick="window.location='index.html'"><i class="fa-solid fa-arrow-left"></i> Volver</button>
  </header>

  <div class="columns">
    <div class="col" id="altas">
      <h2><i class="fa-solid fa-bed"></i> Sugerencias de alta</h2>
      <p id="noAltas">Cargando datos...</p>
    </div>
    <div class="col" id="ingresos">
      <h2><i class="fa-solid fa-user-plus"></i> Sugerencias de ingreso</h2>
      <p id="noIngresos">Cargando datos...</p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://aczjgeleupwlvghjhkav.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFjempnZWxldXB3bHZnaGpoa2F2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzgwODMsImV4cCI6MjA3NjU1NDA4M30.-hQdLNDMw-i4vCpt_OXnzYss5MtVrCu76FhMCPcZPhM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let ocupadas = JSON.parse(localStorage.getItem('habitaciones_ocupadas')) || [];

    // Generador de score determinista (basado en ID)
    function scoreDeterminista(id) {
      let num = parseInt(id.replace(/\D/g, "")) || 0;
      const base = Math.sin(num * 12.345) * 10000;
      const norm = base - Math.floor(base);
      // IDs bajos: pacientes ya ingresados ‚Üí score alto o medio
      if (num <= 11) return 0.6 + norm * 0.35;
      // IDs nuevos ‚Üí score bajo
      return 0.25 + norm * 0.2;
    }

    async function loadDecisiones() {
      const { data: pacientes, error } = await supabase.from("pacientes").select("*");
      if (error) {
        console.error("‚ùå Error cargando pacientes:", error);
        return;
      }

      const altasDiv = document.getElementById("altas");
      const ingresosDiv = document.getElementById("ingresos");
      document.getElementById("noAltas")?.remove();
      document.getElementById("noIngresos")?.remove();
      altasDiv.innerHTML = `<h2><i class="fa-solid fa-bed"></i> Sugerencias de alta</h2>`;
      ingresosDiv.innerHTML = `<h2><i class="fa-solid fa-user-plus"></i> Sugerencias de ingreso</h2>`;

      let sugerenciasAlta = [];
      let sugerenciasIngreso = [];

      pacientes.forEach(p => {
        const idNum = parseInt(p.PacienteID.replace(/\D/g, "")) || 0;
        const enPlanta = ocupadas.includes(p.PacienteID) || idNum <= 11;
        let score = p.trend_score ?? scoreDeterminista(p.PacienteID);

        if (enPlanta && score >= 0.8) {
          sugerenciasAlta.push({ ...p, score });
        } 
        else if (!enPlanta && score <= 0.45) {
          sugerenciasIngreso.push({ ...p, score });
        }
      });

      // Ordenar por score
      sugerenciasAlta.sort((a,b) => b.score - a.score);
      sugerenciasIngreso.sort((a,b) => a.score - b.score);

      // Render altas
      if (sugerenciasAlta.length > 0) {
        sugerenciasAlta.forEach(p => {
          altasDiv.innerHTML += `
            <div class="card" id="card-${p.PacienteID}">
              <strong>${p.Nombre}</strong> (${p.Edad} a√±os, ${p.Sexo})<br>
              Diagn√≥stico: ${p.DiagnosticoPrincipal || "No especificado"}<br>
              <div class="reason">Evoluci√≥n favorable seg√∫n IA. Signos vitales estables.<br>
              <b>Score IA:</b> ${(p.score*100).toFixed(1)}%</div>
              <div class="actions">
                <button onclick="verDetalles('${p.PacienteID}')"><i class="fa-solid fa-notes-medical"></i> Ver resumen</button>
                <button onclick="darAlta('${p.PacienteID}')"><i class="fa-solid fa-up-right-from-square"></i> Dar alta</button>
              </div>
            </div>`;
        });
      } else {
        altasDiv.innerHTML += `<p>No hay pacientes listos para el alta.</p>`;
      }

      // Render ingresos
      if (sugerenciasIngreso.length > 0) {
        sugerenciasIngreso.forEach(p => {
          ingresosDiv.innerHTML += `
            <div class="card" id="card-${p.PacienteID}">
              <strong>${p.Nombre}</strong> (${p.Edad} a√±os, ${p.Sexo})<br>
              Motivo: ${p.MotivoIngreso || "No registrado"}<br>
              <div class="reason">Deterioro cl√≠nico detectado. Requiere ingreso para observaci√≥n.<br>
              <b>Score IA:</b> ${(p.score*100).toFixed(1)}%</div>
              <div class="actions">
                <button onclick="verDetalles('${p.PacienteID}')"><i class="fa-solid fa-notes-medical"></i> Ver resumen</button>
                <button onclick="ingresar('${p.PacienteID}')"><i class="fa-solid fa-bed-pulse"></i> Ingresar</button>
              </div>
            </div>`;
        });
      } else {
        ingresosDiv.innerHTML += `<p>No hay pacientes pendientes de ingreso.</p>`;
      }
    }

    function verDetalles(id) {
      window.open(`paciente.html?id=${id}`, "_blank");
    }

    function darAlta(id) {
      ocupadas = ocupadas.filter(p => p !== id);
      localStorage.setItem('habitaciones_ocupadas', JSON.stringify(ocupadas));
      document.getElementById(`card-${id}`).remove();
      alert(`‚úÖ Paciente ${id} dado de alta. Habitaci√≥n liberada.`);
    }

    function ingresar(id) {
      if (ocupadas.length >= 12) {
        alert("‚ö†Ô∏è No hay habitaciones disponibles.");
        return;
      }
      ocupadas.push(id);
      localStorage.setItem('habitaciones_ocupadas', JSON.stringify(ocupadas));
      document.getElementById(`card-${id}`).remove();
      alert(`ü©∫ Paciente ${id} ingresado correctamente.`);
    }

    loadDecisiones();
  </script>
</body>
</html>
